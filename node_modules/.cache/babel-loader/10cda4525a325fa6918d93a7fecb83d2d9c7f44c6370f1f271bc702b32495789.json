{"ast":null,"code":"import { isAllowCapture, multiplyVec2, invert } from '@antv/g-base';\nfunction invertFromMatrix(v, matrix) {\n  if (matrix) {\n    var invertMatrix = invert(matrix);\n    return multiplyVec2(invertMatrix, v);\n  }\n  return v;\n}\nfunction getRefXY(element, x, y) {\n  // @ts-ignore\n  var totalMatrix = element.getTotalMatrix();\n  if (totalMatrix) {\n    var _a = invertFromMatrix([x, y, 1], totalMatrix),\n      refX = _a[0],\n      refY = _a[1];\n    return [refX, refY];\n  }\n  return [x, y];\n}\n// 拾取前的检测，只有通过检测才能继续拾取\nfunction preTest(element, x, y) {\n  // @ts-ignore\n  if (element.isCanvas && element.isCanvas()) {\n    return true;\n  }\n  // 不允许被拾取，则返回 null\n  // @ts-ignore\n  if (!isAllowCapture(element) || element.cfg.isInView === false) {\n    return false;\n  }\n  if (element.cfg.clipShape) {\n    // 如果存在 clip\n    var _a = getRefXY(element, x, y),\n      refX = _a[0],\n      refY = _a[1];\n    if (element.isClipped(refX, refY)) {\n      return false;\n    }\n  }\n  // @ts-ignore ，这个地方调用过于频繁\n  var bbox = element.cfg.cacheCanvasBBox || element.getCanvasBBox();\n  // 如果没有缓存 bbox，则说明不可见\n  // 注释掉的这段可能会加速拾取，上面的语句改写成 const bbox = element.cfg.cacheCanvasBBox;\n  // 这时候的拾取假设图形/分组在上一次绘制都在视窗内，但是上面已经判定了 isInView 所以意义不大\n  // 现在还调用 element.getCanvasBBox(); 一个很大的原因是便于单元测试\n  // if (!bbox) {\n  //   return false;\n  // }\n  if (!(x >= bbox.minX && x <= bbox.maxX && y >= bbox.minY && y <= bbox.maxY)) {\n    return false;\n  }\n  return true;\n}\n// 这个方法复写了 g-base 的 getShape\nexport function getShape(container, x, y) {\n  // 没有通过检测，则返回 null\n  if (!preTest(container, x, y)) {\n    return null;\n  }\n  var shape = null;\n  var children = container.getChildren();\n  var count = children.length;\n  for (var i = count - 1; i >= 0; i--) {\n    var child = children[i];\n    if (child.isGroup()) {\n      shape = getShape(child, x, y);\n    } else if (preTest(child, x, y)) {\n      var curShape = child;\n      var _a = getRefXY(child, x, y),\n        refX = _a[0],\n        refY = _a[1];\n      // @ts-ignore\n      if (curShape.isInShape(refX, refY)) {\n        shape = child;\n      }\n    }\n    if (shape) {\n      break;\n    }\n  }\n  return shape;\n}","map":{"version":3,"names":["isAllowCapture","multiplyVec2","invert","invertFromMatrix","v","matrix","invertMatrix","getRefXY","element","x","y","totalMatrix","getTotalMatrix","_a","refX","refY","preTest","isCanvas","cfg","isInView","clipShape","isClipped","bbox","cacheCanvasBBox","getCanvasBBox","minX","maxX","minY","maxY","getShape","container","shape","children","getChildren","count","length","i","child","isGroup","curShape","isInShape"],"sources":["../../src/util/hit.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}