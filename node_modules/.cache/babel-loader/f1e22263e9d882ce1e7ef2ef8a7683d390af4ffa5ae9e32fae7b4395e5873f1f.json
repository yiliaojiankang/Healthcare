{"ast":null,"code":"\"use strict\";\n\nrequire(\"core-js/modules/es.array.push.js\");\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n    return extendStatics(d, b);\n  };\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n    function __() {\n      this.constructor = d;\n    }\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar list_1 = __importDefault(require(\"./data/list\"));\nvar graphlib_1 = require(\"@antv/graphlib\");\nvar List = /** @class */function (_super) {\n  __extends(List, _super);\n  function List() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n  return List;\n}(list_1.default);\nvar StateGraph = /** @class */function (_super) {\n  __extends(StateGraph, _super);\n  function StateGraph() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n  return StateGraph;\n}(graphlib_1.Graph);\n/*\n * A greedy heuristic for finding a feedback arc set for a graph. A feedback\n * arc set is a set of edges that can be removed to make a graph acyclic.\n * The algorithm comes from: P. Eades, X. Lin, and W. F. Smyth, \"A fast and\n * effective heuristic for the feedback arc set problem.\" This implementation\n * adjusts that from the paper to allow for weighted edges.\n */\nvar DEFAULT_WEIGHT_FN = function () {\n  return 1;\n};\nvar greedyFAS = function (g, weightFn) {\n  var _a;\n  if (g.nodeCount() <= 1) return [];\n  var state = buildState(g, weightFn || DEFAULT_WEIGHT_FN);\n  var results = doGreedyFAS(state.graph, state.buckets, state.zeroIdx);\n  return (_a = results.map(function (e) {\n    return g.outEdges(e.v, e.w);\n  })) === null || _a === void 0 ? void 0 : _a.flat();\n};\nvar doGreedyFAS = function (g, buckets, zeroIdx) {\n  var results = [];\n  var sources = buckets[buckets.length - 1];\n  var sinks = buckets[0];\n  var entry;\n  while (g.nodeCount()) {\n    while (entry = sinks.dequeue()) {\n      removeNode(g, buckets, zeroIdx, entry);\n    }\n    while (entry = sources.dequeue()) {\n      removeNode(g, buckets, zeroIdx, entry);\n    }\n    if (g.nodeCount()) {\n      for (var i = buckets.length - 2; i > 0; --i) {\n        entry = buckets[i].dequeue();\n        if (entry) {\n          results = results.concat(removeNode(g, buckets, zeroIdx, entry, true));\n          break;\n        }\n      }\n    }\n  }\n  return results;\n};\nvar removeNode = function (g, buckets, zeroIdx, entry, collectPredecessors) {\n  var _a, _b;\n  var results = [];\n  (_a = g.inEdges(entry.v)) === null || _a === void 0 ? void 0 : _a.forEach(function (edge) {\n    var weight = g.edge(edge);\n    var uEntry = g.node(edge.v);\n    if (collectPredecessors) {\n      // this result not really care about in or out\n      results.push({\n        v: edge.v,\n        w: edge.w,\n        in: 0,\n        out: 0\n      });\n    }\n    if (uEntry.out === undefined) uEntry.out = 0;\n    uEntry.out -= weight;\n    assignBucket(buckets, zeroIdx, uEntry);\n  });\n  (_b = g.outEdges(entry.v)) === null || _b === void 0 ? void 0 : _b.forEach(function (edge) {\n    var weight = g.edge(edge);\n    var w = edge.w;\n    var wEntry = g.node(w);\n    if (wEntry.in === undefined) wEntry.in = 0;\n    wEntry.in -= weight;\n    assignBucket(buckets, zeroIdx, wEntry);\n  });\n  g.removeNode(entry.v);\n  return collectPredecessors ? results : undefined;\n};\nvar buildState = function (g, weightFn) {\n  var fasGraph = new StateGraph();\n  var maxIn = 0;\n  var maxOut = 0;\n  g.nodes().forEach(function (v) {\n    fasGraph.setNode(v, {\n      v: v,\n      in: 0,\n      out: 0\n    });\n  });\n  // Aggregate weights on nodes, but also sum the weights across multi-edges\n  // into a single edge for the fasGraph.\n  g.edges().forEach(function (e) {\n    var prevWeight = fasGraph.edge(e) || 0;\n    var weight = (weightFn === null || weightFn === void 0 ? void 0 : weightFn(e)) || 1;\n    var edgeWeight = prevWeight + weight;\n    fasGraph.setEdge(e.v, e.w, edgeWeight);\n    maxOut = Math.max(maxOut, fasGraph.node(e.v).out += weight);\n    maxIn = Math.max(maxIn, fasGraph.node(e.w).in += weight);\n  });\n  var buckets = [];\n  var rangeMax = maxOut + maxIn + 3;\n  for (var i = 0; i < rangeMax; i++) {\n    buckets.push(new List());\n  }\n  var zeroIdx = maxIn + 1;\n  fasGraph.nodes().forEach(function (v) {\n    assignBucket(buckets, zeroIdx, fasGraph.node(v));\n  });\n  return {\n    buckets: buckets,\n    zeroIdx: zeroIdx,\n    graph: fasGraph\n  };\n};\nvar assignBucket = function (buckets, zeroIdx, entry) {\n  if (!entry.out) {\n    buckets[0].enqueue(entry);\n  } else if (!entry[\"in\"]) {\n    buckets[buckets.length - 1].enqueue(entry);\n  } else {\n    buckets[entry.out - entry[\"in\"] + zeroIdx].enqueue(entry);\n  }\n};\nexports.default = greedyFAS;","map":{"version":3,"names":["list_1","__importDefault","require","graphlib_1","List","_super","__extends","default","StateGraph","Graph","DEFAULT_WEIGHT_FN","greedyFAS","g","weightFn","nodeCount","state","buildState","results","doGreedyFAS","graph","buckets","zeroIdx","_a","map","e","outEdges","v","w","flat","sources","length","sinks","entry","dequeue","removeNode","i","concat","collectPredecessors","inEdges","forEach","edge","weight","uEntry","node","push","in","out","undefined","assignBucket","_b","wEntry","fasGraph","maxIn","maxOut","nodes","setNode","edges","prevWeight","edgeWeight","setEdge","Math","max","rangeMax","enqueue","exports"],"sources":["../../../../src/layout/dagre/src/greedy-fas.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}