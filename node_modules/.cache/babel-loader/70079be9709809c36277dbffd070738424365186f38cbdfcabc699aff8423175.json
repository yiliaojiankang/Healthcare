{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { isEqual, isNumber, isFunction } from '@antv/util';\nimport * as d3Timer from 'd3-timer';\nimport { interpolate, interpolateArray } from 'd3-interpolate'; // 目前整体动画只需要数值和数组的差值计算\nimport { getEasing } from './register';\nimport * as PathUtil from '../util/path';\nimport { isColorProp, isGradientColor } from '../util/color';\nvar IDENTITY_MATRIX = [1, 0, 0, 0, 1, 0, 0, 0, 1];\n/**\n * 使用 ratio 进行插值计算来更新属性\n * @param {IElement}  shape    元素\n * @param {Animation} animation 动画\n * @param {number}    ratio    比例\n * @return {boolean}  动画是否执行完成\n */\nfunction _update(shape, animation, ratio) {\n  var cProps = {}; // 此刻属性\n  var fromAttrs = animation.fromAttrs,\n    toAttrs = animation.toAttrs;\n  if (shape.destroyed) {\n    return;\n  }\n  var interf; //  差值函数\n  for (var k in toAttrs) {\n    if (!isEqual(fromAttrs[k], toAttrs[k])) {\n      if (k === 'path') {\n        var toPath = toAttrs[k];\n        var fromPath = fromAttrs[k];\n        if (toPath.length > fromPath.length) {\n          toPath = PathUtil.parsePathString(toAttrs[k]); // 终点状态\n          fromPath = PathUtil.parsePathString(fromAttrs[k]); // 起始状态\n          fromPath = PathUtil.fillPathByDiff(fromPath, toPath);\n          fromPath = PathUtil.formatPath(fromPath, toPath);\n          animation.fromAttrs.path = fromPath;\n          animation.toAttrs.path = toPath;\n        } else if (!animation.pathFormatted) {\n          toPath = PathUtil.parsePathString(toAttrs[k]);\n          fromPath = PathUtil.parsePathString(fromAttrs[k]);\n          fromPath = PathUtil.formatPath(fromPath, toPath);\n          animation.fromAttrs.path = fromPath;\n          animation.toAttrs.path = toPath;\n          animation.pathFormatted = true;\n        }\n        cProps[k] = [];\n        for (var i = 0; i < toPath.length; i++) {\n          var toPathPoint = toPath[i];\n          var fromPathPoint = fromPath[i];\n          var cPathPoint = [];\n          for (var j = 0; j < toPathPoint.length; j++) {\n            if (isNumber(toPathPoint[j]) && fromPathPoint && isNumber(fromPathPoint[j])) {\n              interf = interpolate(fromPathPoint[j], toPathPoint[j]);\n              cPathPoint.push(interf(ratio));\n            } else {\n              cPathPoint.push(toPathPoint[j]);\n            }\n          }\n          cProps[k].push(cPathPoint);\n        }\n      } else if (k === 'matrix') {\n        /*\n         对矩阵进行插值时，需要保证矩阵不为空，为空则使用单位矩阵\n         TODO: 二维和三维场景下单位矩阵不同，之后 WebGL 版需要做进一步处理\n         */\n        var matrixFn = interpolateArray(fromAttrs[k] || IDENTITY_MATRIX, toAttrs[k] || IDENTITY_MATRIX);\n        var currentMatrix = matrixFn(ratio);\n        cProps[k] = currentMatrix;\n      } else if (isColorProp(k) && isGradientColor(toAttrs[k])) {\n        cProps[k] = toAttrs[k];\n      } else if (!isFunction(toAttrs[k])) {\n        // 非函数类型的值才能做插值\n        interf = interpolate(fromAttrs[k], toAttrs[k]);\n        cProps[k] = interf(ratio);\n      }\n    }\n  }\n  shape.attr(cProps);\n}\n/**\n * 根据自定义帧动画函数 onFrame 来更新属性\n * @param {IElement}  shape    元素\n * @param {Animation} animation 动画\n * @param {number}    elapsed  动画执行时间(毫秒)\n * @return {boolean}  动画是否执行完成\n */\nfunction update(shape, animation, elapsed) {\n  var startTime = animation.startTime,\n    delay = animation.delay;\n  // 如果还没有开始执行或暂停，先不更新\n  if (elapsed < startTime + delay || animation._paused) {\n    return false;\n  }\n  var ratio;\n  var duration = animation.duration;\n  var easing = animation.easing;\n  var easeFn = getEasing(easing);\n  // 已执行时间\n  elapsed = elapsed - startTime - animation.delay;\n  if (animation.repeat) {\n    // 如果动画重复执行，则 elapsed > duration，计算 ratio 时需取模\n    ratio = elapsed % duration / duration;\n    ratio = easeFn(ratio);\n  } else {\n    ratio = elapsed / duration;\n    if (ratio < 1) {\n      // 动画未执行完\n      ratio = easeFn(ratio);\n    } else {\n      // 动画已执行完\n      if (animation.onFrame) {\n        shape.attr(animation.onFrame(1));\n      } else {\n        shape.attr(animation.toAttrs);\n      }\n      return true;\n    }\n  }\n  if (animation.onFrame) {\n    var attrs = animation.onFrame(ratio);\n    shape.attr(attrs);\n  } else {\n    _update(shape, animation, ratio);\n  }\n  return false;\n}\nvar Timeline = /** @class */function () {\n  /**\n   * 时间轴构造函数，依赖于画布\n   * @param {}\n   */\n  function Timeline(canvas) {\n    /**\n     * 执行动画的元素列表\n     * @type {IElement[]}\n     */\n    this.animators = [];\n    /**\n     * 当前时间\n     * @type {number}\n     */\n    this.current = 0;\n    /**\n     * 定时器\n     * @type {d3Timer.Timer}\n     */\n    this.timer = null;\n    this.canvas = canvas;\n  }\n  /**\n   * 初始化定时器\n   */\n  Timeline.prototype.initTimer = function () {\n    var _this = this;\n    var isFinished = false;\n    var shape;\n    var animations;\n    var animation;\n    this.timer = d3Timer.timer(function (elapsed) {\n      _this.current = elapsed;\n      if (_this.animators.length > 0) {\n        for (var i = _this.animators.length - 1; i >= 0; i--) {\n          shape = _this.animators[i];\n          if (shape.destroyed) {\n            // 如果已经被销毁，直接移出队列\n            _this.removeAnimator(i);\n            continue;\n          }\n          if (!shape.isAnimatePaused()) {\n            animations = shape.get('animations');\n            for (var j = animations.length - 1; j >= 0; j--) {\n              animation = animations[j];\n              isFinished = update(shape, animation, elapsed);\n              if (isFinished) {\n                animations.splice(j, 1);\n                isFinished = false;\n                if (animation.callback) {\n                  animation.callback();\n                }\n              }\n            }\n          }\n          if (animations.length === 0) {\n            _this.removeAnimator(i);\n          }\n        }\n        var autoDraw = _this.canvas.get('autoDraw');\n        // 非自动渲染模式下，手动调用 canvas.draw() 重新渲染\n        if (!autoDraw) {\n          _this.canvas.draw();\n        }\n      }\n    });\n  };\n  /**\n   * 增加动画元素\n   */\n  Timeline.prototype.addAnimator = function (shape) {\n    this.animators.push(shape);\n  };\n  /**\n   * 移除动画元素\n   */\n  Timeline.prototype.removeAnimator = function (index) {\n    this.animators.splice(index, 1);\n  };\n  /**\n   * 是否有动画在执行\n   */\n  Timeline.prototype.isAnimating = function () {\n    return !!this.animators.length;\n  };\n  /**\n   * 停止定时器\n   */\n  Timeline.prototype.stop = function () {\n    if (this.timer) {\n      this.timer.stop();\n    }\n  };\n  /**\n   * 停止时间轴上所有元素的动画，并置空动画元素列表\n   * @param {boolean} toEnd 是否到动画的最终状态，用来透传给动画元素的 stopAnimate 方法\n   */\n  Timeline.prototype.stopAllAnimations = function (toEnd) {\n    if (toEnd === void 0) {\n      toEnd = true;\n    }\n    this.animators.forEach(function (animator) {\n      animator.stopAnimate(toEnd);\n    });\n    this.animators = [];\n    this.canvas.draw();\n  };\n  /**\n   * 获取当前时间\n   */\n  Timeline.prototype.getTime = function () {\n    return this.current;\n  };\n  return Timeline;\n}();\nexport default Timeline;","map":{"version":3,"names":["isEqual","isNumber","isFunction","d3Timer","interpolate","interpolateArray","getEasing","PathUtil","isColorProp","isGradientColor","IDENTITY_MATRIX","_update","shape","animation","ratio","cProps","fromAttrs","toAttrs","destroyed","interf","k","toPath","fromPath","length","parsePathString","fillPathByDiff","formatPath","path","pathFormatted","i","toPathPoint","fromPathPoint","cPathPoint","j","push","matrixFn","currentMatrix","attr","update","elapsed","startTime","delay","_paused","duration","easing","easeFn","repeat","onFrame","attrs","Timeline","canvas","animators","current","timer","prototype","initTimer","_this","isFinished","animations","removeAnimator","isAnimatePaused","get","splice","callback","autoDraw","draw","addAnimator","index","isAnimating","stop","stopAllAnimations","toEnd","forEach","animator","stopAnimate","getTime"],"sources":["../../src/animate/timeline.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}