{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { clone, each, isFunction } from '@antv/util';\nimport { animation, annotation, scale, theme, tooltip } from '../../adaptor/common';\nimport { getLocale } from '../../core/locale';\nimport { deepAssign, flow } from '../../utils';\nimport { conversionTagFormatter } from '../../utils/conversion';\nimport { FUNNEL_CONVERSATION, FUNNEL_PERCENT } from './constant';\nimport { basicFunnel } from './geometries/basic';\nimport { compareFunnel } from './geometries/compare';\nimport { dynamicHeightFunnel } from './geometries/dynamic-height';\nimport { facetFunnel } from './geometries/facet';\nimport { FUNNEL_LEGEND_FILTER, interactionStart } from './interactions';\n/**\n *\n * 各式漏斗图geometry实现细节有较大不同,\n * 1. 普通漏斗图：interval.shape('funnel')\n * 2. 对比漏斗图：分面\n * 3. 动态高度漏斗图：polypon\n * 4. 分面漏斗图：普通 + list 分面\n* /\n\n/**\n * options 处理\n * @param params\n */\nfunction defaultOptions(params) {\n  var options = params.options;\n  var compareField = options.compareField,\n    xField = options.xField,\n    yField = options.yField,\n    locale = options.locale,\n    funnelStyle = options.funnelStyle,\n    data = options.data;\n  var i18n = getLocale(locale);\n  var defaultOption = {\n    label: compareField ? {\n      fields: [xField, yField, compareField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n      formatter: function (datum) {\n        return \"\".concat(datum[yField]);\n      }\n    } : {\n      fields: [xField, yField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n      offset: 0,\n      position: 'middle',\n      formatter: function (datum) {\n        return \"\".concat(datum[xField], \" \").concat(datum[yField]);\n      }\n    },\n    tooltip: {\n      title: xField,\n      formatter: function (datum) {\n        return {\n          name: datum[xField],\n          value: datum[yField]\n        };\n      }\n    },\n    conversionTag: {\n      // conversionTag 的计算和显示逻辑统一保持一致\n      formatter: function (datum) {\n        return \"\".concat(i18n.get(['conversionTag', 'label']), \": \").concat(conversionTagFormatter.apply(void 0, datum[FUNNEL_CONVERSATION]));\n      }\n    }\n  };\n  // 漏斗图样式\n  var style;\n  if (compareField || funnelStyle) {\n    style = function (datum) {\n      return deepAssign({},\n      // 对比漏斗图默认描边\n      compareField && {\n        lineWidth: 1,\n        stroke: '#fff'\n      }, isFunction(funnelStyle) ? funnelStyle(datum) : funnelStyle);\n    };\n  }\n  return deepAssign({\n    options: defaultOption\n  }, params, {\n    options: {\n      funnelStyle: style,\n      data: clone(data)\n    }\n  });\n}\n/**\n * geometry处理\n * @param params\n */\nfunction geometry(params) {\n  var options = params.options;\n  var compareField = options.compareField,\n    dynamicHeight = options.dynamicHeight,\n    seriesField = options.seriesField;\n  if (seriesField) {\n    return facetFunnel(params);\n  }\n  if (compareField) {\n    return compareFunnel(params);\n  }\n  if (dynamicHeight) {\n    return dynamicHeightFunnel(params);\n  }\n  return basicFunnel(params);\n}\n/**\n * meta 配置\n * @param params\n */\nexport function meta(params) {\n  var _a;\n  var options = params.options;\n  var xAxis = options.xAxis,\n    yAxis = options.yAxis,\n    xField = options.xField,\n    yField = options.yField;\n  return flow(scale((_a = {}, _a[xField] = xAxis, _a[yField] = yAxis, _a)))(params);\n}\n/**\n * 坐标轴\n * @param params\n */\nfunction axis(params) {\n  var chart = params.chart;\n  chart.axis(false);\n  return params;\n}\n/**\n * legend 配置\n * @param params\n */\nfunction legend(params) {\n  var chart = params.chart,\n    options = params.options;\n  var legend = options.legend;\n  if (legend === false) {\n    chart.legend(false);\n  } else {\n    chart.legend(legend);\n    // TODO FIX: legend-click 时间和转化率组件之间的关联\n  }\n\n  return params;\n}\n/**\n * Interaction 配置\n * @param params\n */\nexport function interaction(params) {\n  var chart = params.chart,\n    options = params.options;\n  // @ts-ignore\n  var interactions = options.interactions,\n    dynamicHeight = options.dynamicHeight;\n  each(interactions, function (i) {\n    if (i.enable === false) {\n      chart.removeInteraction(i.type);\n    } else {\n      chart.interaction(i.type, i.cfg || {});\n    }\n  });\n  // 动态高度  不进行交互操作\n  if (!dynamicHeight) {\n    chart.interaction(FUNNEL_LEGEND_FILTER, {\n      start: [__assign(__assign({}, interactionStart), {\n        arg: options\n      })]\n    });\n  } else {\n    chart.removeInteraction(FUNNEL_LEGEND_FILTER);\n  }\n  return params;\n}\n/**\n * 漏斗图适配器\n * @param chart\n * @param options\n */\nexport function adaptor(params) {\n  return flow(defaultOptions, geometry, meta, axis, tooltip, interaction, legend, animation, theme, annotation())(params);\n}","map":{"version":3,"names":["clone","each","isFunction","animation","annotation","scale","theme","tooltip","getLocale","deepAssign","flow","conversionTagFormatter","FUNNEL_CONVERSATION","FUNNEL_PERCENT","basicFunnel","compareFunnel","dynamicHeightFunnel","facetFunnel","FUNNEL_LEGEND_FILTER","interactionStart","defaultOptions","params","options","compareField","xField","yField","locale","funnelStyle","data","i18n","defaultOption","label","fields","formatter","datum","concat","offset","position","title","name","value","conversionTag","get","apply","style","lineWidth","stroke","geometry","dynamicHeight","seriesField","meta","xAxis","yAxis","_a","axis","chart","legend","interaction","interactions","i","enable","removeInteraction","type","cfg","start","__assign","arg","adaptor"],"sources":["../../../src/plots/funnel/adaptor.ts"],"sourcesContent":["import { clone, each, isFunction } from '@antv/util';\nimport { animation, annotation, scale, theme, tooltip } from '../../adaptor/common';\nimport { Params } from '../../core/adaptor';\nimport { getLocale } from '../../core/locale';\nimport { Datum } from '../../types';\nimport { deepAssign, flow } from '../../utils';\nimport { conversionTagFormatter } from '../../utils/conversion';\nimport { FUNNEL_CONVERSATION, FUNNEL_PERCENT } from './constant';\nimport { basicFunnel } from './geometries/basic';\nimport { compareFunnel } from './geometries/compare';\nimport { dynamicHeightFunnel } from './geometries/dynamic-height';\nimport { facetFunnel } from './geometries/facet';\nimport { FUNNEL_LEGEND_FILTER, interactionStart } from './interactions';\nimport { FunnelOptions } from './types';\nimport type { Interaction } from './types';\n\n/**\n *\n * 各式漏斗图geometry实现细节有较大不同,\n * 1. 普通漏斗图：interval.shape('funnel')\n * 2. 对比漏斗图：分面\n * 3. 动态高度漏斗图：polypon\n * 4. 分面漏斗图：普通 + list 分面\n* /\n\n/**\n * options 处理\n * @param params\n */\nfunction defaultOptions(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { options } = params;\n  const { compareField, xField, yField, locale, funnelStyle, data } = options;\n  const i18n = getLocale(locale);\n\n  const defaultOption = {\n    label: compareField\n      ? {\n          fields: [xField, yField, compareField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n          formatter: (datum) => `${datum[yField]}`,\n        }\n      : {\n          fields: [xField, yField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n          offset: 0,\n          position: 'middle',\n          formatter: (datum) => `${datum[xField]} ${datum[yField]}`,\n        },\n    tooltip: {\n      title: xField,\n      formatter: (datum) => {\n        return { name: datum[xField], value: datum[yField] };\n      },\n    },\n    conversionTag: {\n      // conversionTag 的计算和显示逻辑统一保持一致\n      formatter: (datum) =>\n        `${i18n.get(['conversionTag', 'label'])}: ${conversionTagFormatter(\n          ...(datum[FUNNEL_CONVERSATION] as [number, number])\n        )}`,\n    },\n  };\n\n  // 漏斗图样式\n  let style;\n  if (compareField || funnelStyle) {\n    style = (datum: Datum) => {\n      return deepAssign(\n        {},\n        // 对比漏斗图默认描边\n        compareField && { lineWidth: 1, stroke: '#fff' },\n        isFunction(funnelStyle) ? funnelStyle(datum) : funnelStyle\n      );\n    };\n  }\n\n  return deepAssign({ options: defaultOption }, params, { options: { funnelStyle: style, data: clone(data) } });\n}\n\n/**\n * geometry处理\n * @param params\n */\nfunction geometry(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { options } = params;\n  const { compareField, dynamicHeight, seriesField } = options;\n  if (seriesField) {\n    return facetFunnel(params);\n  }\n  if (compareField) {\n    return compareFunnel(params);\n  }\n  if (dynamicHeight) {\n    return dynamicHeightFunnel(params);\n  }\n\n  return basicFunnel(params);\n}\n\n/**\n * meta 配置\n * @param params\n */\nexport function meta(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { options } = params;\n  const { xAxis, yAxis, xField, yField } = options;\n\n  return flow(\n    scale({\n      [xField]: xAxis,\n      [yField]: yAxis,\n    })\n  )(params);\n}\n\n/**\n * 坐标轴\n * @param params\n */\nfunction axis(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart } = params;\n  chart.axis(false);\n  return params;\n}\n\n/**\n * legend 配置\n * @param params\n */\nfunction legend(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart, options } = params;\n  const { legend } = options;\n\n  if (legend === false) {\n    chart.legend(false);\n  } else {\n    chart.legend(legend);\n    // TODO FIX: legend-click 时间和转化率组件之间的关联\n  }\n\n  return params;\n}\n\n/**\n * Interaction 配置\n * @param params\n */\nexport function interaction<O extends Pick<FunnelOptions, 'interactions'>>(params: Params<O>): Params<O> {\n  const { chart, options } = params;\n  // @ts-ignore\n  const { interactions, dynamicHeight } = options;\n\n  each(interactions, (i: Interaction) => {\n    if (i.enable === false) {\n      chart.removeInteraction(i.type);\n    } else {\n      chart.interaction(i.type, i.cfg || {});\n    }\n  });\n  // 动态高度  不进行交互操作\n  if (!dynamicHeight) {\n    chart.interaction(FUNNEL_LEGEND_FILTER, {\n      start: [{ ...interactionStart, arg: options }],\n    });\n  } else {\n    chart.removeInteraction(FUNNEL_LEGEND_FILTER);\n  }\n\n  return params;\n}\n\n/**\n * 漏斗图适配器\n * @param chart\n * @param options\n */\nexport function adaptor(params: Params<FunnelOptions>) {\n  return flow(\n    defaultOptions,\n    geometry,\n    meta,\n    axis,\n    tooltip,\n    interaction,\n    legend,\n    animation,\n    theme,\n    annotation()\n  )(params);\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}