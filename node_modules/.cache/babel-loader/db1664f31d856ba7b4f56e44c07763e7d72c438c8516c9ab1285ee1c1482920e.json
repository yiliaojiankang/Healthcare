{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { __assign, __extends, __read, __rest, __values } from \"tslib\";\nimport { contains, deepMix, each, get, isArray, isFunction, isNil, isString, keys, upperFirst, find, includes } from '@antv/util';\nimport { Annotation as AnnotationComponent } from '../../dependents';\nimport { DEFAULT_ANIMATE_CFG } from '../../animate/';\nimport { COMPONENT_TYPE, DIRECTION, GEOMETRY_LIFE_CIRCLE, LAYER, VIEW_LIFE_CIRCLE } from '../../constant';\nimport { getAngleByPoint, getDistanceToCenter } from '../../util/coordinate';\nimport { omit } from '../../util/helper';\nimport { getNormalizedValue } from '../../util/annotation';\nimport { Controller } from './base';\n/** 需要在图形绘制完成后才渲染的辅助组件类型列表 */\nvar ANNOTATIONS_AFTER_RENDER = ['regionFilter', 'shape'];\n/**\n * Annotation controller, 主要作用:\n * 1. 创建 Annotation: line、text、arc ...\n * 2. 生命周期: init、layout、render、clear、destroy\n */\nvar Annotation = /** @class */function (_super) {\n  __extends(Annotation, _super);\n  function Annotation(view) {\n    var _this = _super.call(this, view) || this;\n    /* 组件更新的 cache，组件配置 object : 组件 */\n    _this.cache = new Map();\n    _this.foregroundContainer = _this.view.getLayer(LAYER.FORE).addGroup();\n    _this.backgroundContainer = _this.view.getLayer(LAYER.BG).addGroup();\n    _this.option = [];\n    return _this;\n  }\n  Object.defineProperty(Annotation.prototype, \"name\", {\n    get: function () {\n      return 'annotation';\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Annotation.prototype.init = function () {};\n  /**\n   * 因为 annotation 需要依赖坐标系信息，所以 render 阶段为空方法，实际的创建逻辑都在 layout 中\n   */\n  Annotation.prototype.layout = function () {\n    this.update();\n  };\n  // 因为 Annotation 不参与布局，但是渲染的位置依赖于坐标系，所以可以将绘制阶段延迟到 layout() 进行\n  Annotation.prototype.render = function () {};\n  /**\n   * 更新\n   */\n  Annotation.prototype.update = function () {\n    var _this = this;\n    // 1. 先处理需要在图形渲染之后的辅助组件 需要在 Geometry 完成之后，拿到图形信息\n    this.onAfterRender(function () {\n      var updated = new Map();\n      // 先看是否有 regionFilter/shape 要更新\n      each(_this.option, function (option) {\n        if (includes(ANNOTATIONS_AFTER_RENDER, option.type)) {\n          var co = _this.updateOrCreate(option);\n          // 存储已经处理过的\n          if (co) {\n            updated.set(_this.getCacheKey(option), co);\n          }\n        }\n      });\n      // 处理完成之后，更新 cache\n      // 处理完成之后，销毁删除的\n      _this.cache = _this.syncCache(updated);\n    });\n    // 2. 处理非 regionFilter\n    var updateCache = new Map();\n    each(this.option, function (option) {\n      if (!includes(ANNOTATIONS_AFTER_RENDER, option.type)) {\n        var co = _this.updateOrCreate(option);\n        // 存储已经处理过的\n        if (co) {\n          updateCache.set(_this.getCacheKey(option), co);\n        }\n      }\n    });\n    this.cache = this.syncCache(updateCache);\n  };\n  /**\n   * 清空\n   * @param includeOption 是否清空 option 配置项\n   */\n  Annotation.prototype.clear = function (includeOption) {\n    if (includeOption === void 0) {\n      includeOption = false;\n    }\n    _super.prototype.clear.call(this);\n    this.clearComponents();\n    this.foregroundContainer.clear();\n    this.backgroundContainer.clear();\n    // clear all option\n    if (includeOption) {\n      this.option = [];\n    }\n  };\n  Annotation.prototype.destroy = function () {\n    this.clear(true);\n    this.foregroundContainer.remove(true);\n    this.backgroundContainer.remove(true);\n  };\n  /**\n   * 复写基类的方法\n   */\n  Annotation.prototype.getComponents = function () {\n    var co = [];\n    this.cache.forEach(function (value) {\n      co.push(value);\n    });\n    return co;\n  };\n  /**\n   * 清除当前的组件\n   */\n  Annotation.prototype.clearComponents = function () {\n    this.getComponents().forEach(function (co) {\n      co.component.destroy();\n    });\n    this.cache.clear();\n  };\n  /**\n   * region filter 比较特殊的渲染时机\n   * @param doWhat\n   */\n  Annotation.prototype.onAfterRender = function (doWhat) {\n    var done = false;\n    if (this.view.getOptions().animate) {\n      this.view.geometries.forEach(function (g) {\n        // 如果 geometry 开启，则监听\n        if (g.animateOption) {\n          g.once(GEOMETRY_LIFE_CIRCLE.AFTER_DRAW_ANIMATE, function () {\n            doWhat();\n          });\n          done = true;\n        }\n      });\n    }\n    if (!done) {\n      this.view.getRootView().once(VIEW_LIFE_CIRCLE.AFTER_RENDER, function () {\n        doWhat();\n      });\n    }\n  };\n  Annotation.prototype.createAnnotation = function (option) {\n    var type = option.type;\n    var Ctor = AnnotationComponent[upperFirst(type)];\n    if (Ctor) {\n      var theme = this.getAnnotationTheme(type);\n      var cfg = this.getAnnotationCfg(type, option, theme);\n      // 不创建\n      if (!cfg) {\n        return null;\n      }\n      var annotation = new Ctor(cfg);\n      return {\n        component: annotation,\n        layer: this.isTop(cfg) ? LAYER.FORE : LAYER.BG,\n        direction: DIRECTION.NONE,\n        type: COMPONENT_TYPE.ANNOTATION,\n        extra: option\n      };\n    }\n  };\n  // APIs for creating annotation component\n  Annotation.prototype.annotation = function (option) {\n    this.option.push(option);\n  };\n  /**\n   * 创建 Arc\n   * @param option\n   * @returns AnnotationController\n   */\n  Annotation.prototype.arc = function (option) {\n    this.annotation(__assign({\n      type: 'arc'\n    }, option));\n    return this;\n  };\n  /**\n   * 创建 image\n   * @param option\n   * @returns AnnotationController\n   */\n  Annotation.prototype.image = function (option) {\n    this.annotation(__assign({\n      type: 'image'\n    }, option));\n    return this;\n  };\n  /**\n   * 创建 Line\n   * @param option\n   * @returns AnnotationController\n   */\n  Annotation.prototype.line = function (option) {\n    this.annotation(__assign({\n      type: 'line'\n    }, option));\n    return this;\n  };\n  /**\n   * 创建 Region\n   * @param option\n   * @returns AnnotationController\n   */\n  Annotation.prototype.region = function (option) {\n    this.annotation(__assign({\n      type: 'region'\n    }, option));\n    return this;\n  };\n  /**\n   * 创建 Text\n   * @param option\n   * @returns AnnotationController\n   */\n  Annotation.prototype.text = function (option) {\n    this.annotation(__assign({\n      type: 'text'\n    }, option));\n    return this;\n  };\n  /**\n   * 创建 DataMarker\n   * @param option\n   * @returns AnnotationController\n   */\n  Annotation.prototype.dataMarker = function (option) {\n    this.annotation(__assign({\n      type: 'dataMarker'\n    }, option));\n    return this;\n  };\n  /**\n   * 创建 DataRegion\n   * @param option\n   * @returns AnnotationController\n   */\n  Annotation.prototype.dataRegion = function (option) {\n    this.annotation(__assign({\n      type: 'dataRegion'\n    }, option));\n  };\n  /**\n   * 创建 RegionFilter\n   * @param option\n   * @returns AnnotationController\n   */\n  Annotation.prototype.regionFilter = function (option) {\n    this.annotation(__assign({\n      type: 'regionFilter'\n    }, option));\n  };\n  /**\n   * 创建 ShapeAnnotation\n   * @param option\n   */\n  Annotation.prototype.shape = function (option) {\n    this.annotation(__assign({\n      type: 'shape'\n    }, option));\n  };\n  /**\n   * 创建 HtmlAnnotation\n   * @param option\n   */\n  Annotation.prototype.html = function (option) {\n    this.annotation(__assign({\n      type: 'html'\n    }, option));\n  };\n  // end API\n  /**\n   * parse the point position to [x, y]\n   * @param p Position\n   * @returns { x, y }\n   */\n  Annotation.prototype.parsePosition = function (p) {\n    var e_1, _a;\n    var xScale = this.view.getXScale();\n    // 转成 object\n    var yScales = this.view.getScalesByDim('y');\n    var position = isFunction(p) ? p.call(null, xScale, yScales) : p;\n    var x = 0;\n    var y = 0;\n    // 入参是 [24, 24] 这类时\n    if (isArray(position)) {\n      var _b = __read(position, 2),\n        xPos = _b[0],\n        yPos = _b[1];\n      // 如果数据格式是 ['50%', '50%'] 的格式\n      // fix: 原始数据中可能会包含 'xxx5%xxx' 这样的数据，需要判断下 https://github.com/antvis/f2/issues/590\n      // @ts-ignore\n      if (isString(xPos) && xPos.indexOf('%') !== -1 && !isNaN(xPos.slice(0, -1))) {\n        return this.parsePercentPosition(position);\n      }\n      x = getNormalizedValue(xPos, xScale);\n      y = getNormalizedValue(yPos, Object.values(yScales)[0]);\n    } else if (!isNil(position)) {\n      try {\n        // 入参是 object 结构，数据点\n        for (var _c = __values(keys(position)), _d = _c.next(); !_d.done; _d = _c.next()) {\n          var key = _d.value;\n          var value = position[key];\n          if (key === xScale.field) {\n            x = getNormalizedValue(value, xScale);\n          }\n          if (yScales[key]) {\n            y = getNormalizedValue(value, yScales[key]);\n          }\n        }\n      } catch (e_1_1) {\n        e_1 = {\n          error: e_1_1\n        };\n      } finally {\n        try {\n          if (_d && !_d.done && (_a = _c.return)) _a.call(_c);\n        } finally {\n          if (e_1) throw e_1.error;\n        }\n      }\n    }\n    if (isNaN(x) || isNaN(y)) {\n      return null;\n    }\n    return this.view.getCoordinate().convert({\n      x: x,\n      y: y\n    });\n  };\n  /**\n   * parse all the points between start and end\n   * @param start\n   * @param end\n   * @return Point[]\n   */\n  Annotation.prototype.getRegionPoints = function (start, end) {\n    var _this = this;\n    var xScale = this.view.getXScale();\n    var yScales = this.view.getScalesByDim('y');\n    var yScale = Object.values(yScales)[0];\n    var xField = xScale.field;\n    var viewData = this.view.getData();\n    var startXValue = isArray(start) ? start[0] : start[xField];\n    var endXValue = isArray(end) ? end[0] : end[xField];\n    var arr = [];\n    var startIndex;\n    each(viewData, function (item, idx) {\n      if (item[xField] === startXValue) {\n        startIndex = idx;\n      }\n      if (idx >= startIndex) {\n        var point = _this.parsePosition([item[xField], item[yScale.field]]);\n        if (point) {\n          arr.push(point);\n        }\n      }\n      if (item[xField] === endXValue) {\n        return false;\n      }\n    });\n    return arr;\n  };\n  /**\n   * parse percent position\n   * @param position\n   */\n  Annotation.prototype.parsePercentPosition = function (position) {\n    var xPercent = parseFloat(position[0]) / 100;\n    var yPercent = parseFloat(position[1]) / 100;\n    var coordinate = this.view.getCoordinate();\n    var start = coordinate.start,\n      end = coordinate.end;\n    var topLeft = {\n      x: Math.min(start.x, end.x),\n      y: Math.min(start.y, end.y)\n    };\n    var x = coordinate.getWidth() * xPercent + topLeft.x;\n    var y = coordinate.getHeight() * yPercent + topLeft.y;\n    return {\n      x: x,\n      y: y\n    };\n  };\n  /**\n   * get coordinate bbox\n   */\n  Annotation.prototype.getCoordinateBBox = function () {\n    var coordinate = this.view.getCoordinate();\n    var start = coordinate.start,\n      end = coordinate.end;\n    var width = coordinate.getWidth();\n    var height = coordinate.getHeight();\n    var topLeft = {\n      x: Math.min(start.x, end.x),\n      y: Math.min(start.y, end.y)\n    };\n    return {\n      x: topLeft.x,\n      y: topLeft.y,\n      minX: topLeft.x,\n      minY: topLeft.y,\n      maxX: topLeft.x + width,\n      maxY: topLeft.y + height,\n      width: width,\n      height: height\n    };\n  };\n  /**\n   * get annotation component config by different type\n   * @param type\n   * @param option 用户的配置\n   * @param theme\n   */\n  Annotation.prototype.getAnnotationCfg = function (type, option, theme) {\n    var _this = this;\n    var coordinate = this.view.getCoordinate();\n    var canvas = this.view.getCanvas();\n    var o = {};\n    if (isNil(option)) {\n      return null;\n    }\n    var start = option.start,\n      end = option.end,\n      position = option.position;\n    var sp = this.parsePosition(start);\n    var ep = this.parsePosition(end);\n    var textPoint = this.parsePosition(position);\n    if (['arc', 'image', 'line', 'region', 'regionFilter'].includes(type) && (!sp || !ep)) {\n      return null;\n    } else if (['text', 'dataMarker', 'html'].includes(type) && !textPoint) {\n      return null;\n    }\n    if (type === 'arc') {\n      var _a = option,\n        start_1 = _a.start,\n        end_1 = _a.end,\n        rest = __rest(_a, [\"start\", \"end\"]);\n      var startAngle = getAngleByPoint(coordinate, sp);\n      var endAngle = getAngleByPoint(coordinate, ep);\n      if (startAngle > endAngle) {\n        endAngle = Math.PI * 2 + endAngle;\n      }\n      o = __assign(__assign({}, rest), {\n        center: coordinate.getCenter(),\n        radius: getDistanceToCenter(coordinate, sp),\n        startAngle: startAngle,\n        endAngle: endAngle\n      });\n    } else if (type === 'image') {\n      var _b = option,\n        start_2 = _b.start,\n        end_2 = _b.end,\n        rest = __rest(_b, [\"start\", \"end\"]);\n      o = __assign(__assign({}, rest), {\n        start: sp,\n        end: ep,\n        src: option.src\n      });\n    } else if (type === 'line') {\n      var _c = option,\n        start_3 = _c.start,\n        end_3 = _c.end,\n        rest = __rest(_c, [\"start\", \"end\"]);\n      o = __assign(__assign({}, rest), {\n        start: sp,\n        end: ep,\n        text: get(option, 'text', null)\n      });\n    } else if (type === 'region') {\n      var _d = option,\n        start_4 = _d.start,\n        end_4 = _d.end,\n        rest = __rest(_d, [\"start\", \"end\"]);\n      o = __assign(__assign({}, rest), {\n        start: sp,\n        end: ep\n      });\n    } else if (type === 'text') {\n      var filteredData = this.view.getData();\n      var _e = option,\n        position_1 = _e.position,\n        content = _e.content,\n        rest = __rest(_e, [\"position\", \"content\"]);\n      var textContent = content;\n      if (isFunction(content)) {\n        textContent = content(filteredData);\n      }\n      o = __assign(__assign(__assign({}, textPoint), rest), {\n        content: textContent\n      });\n    } else if (type === 'dataMarker') {\n      var _f = option,\n        position_2 = _f.position,\n        point = _f.point,\n        line = _f.line,\n        text = _f.text,\n        autoAdjust = _f.autoAdjust,\n        direction = _f.direction,\n        rest = __rest(_f, [\"position\", \"point\", \"line\", \"text\", \"autoAdjust\", \"direction\"]);\n      o = __assign(__assign(__assign({}, rest), textPoint), {\n        coordinateBBox: this.getCoordinateBBox(),\n        point: point,\n        line: line,\n        text: text,\n        autoAdjust: autoAdjust,\n        direction: direction\n      });\n    } else if (type === 'dataRegion') {\n      var _g = option,\n        start_5 = _g.start,\n        end_5 = _g.end,\n        region = _g.region,\n        text = _g.text,\n        lineLength = _g.lineLength,\n        rest = __rest(_g, [\"start\", \"end\", \"region\", \"text\", \"lineLength\"]);\n      o = __assign(__assign({}, rest), {\n        points: this.getRegionPoints(start_5, end_5),\n        region: region,\n        text: text,\n        lineLength: lineLength\n      });\n    } else if (type === 'regionFilter') {\n      var _h = option,\n        start_6 = _h.start,\n        end_6 = _h.end,\n        apply_1 = _h.apply,\n        color = _h.color,\n        rest = __rest(_h, [\"start\", \"end\", \"apply\", \"color\"]);\n      var geometries = this.view.geometries;\n      var shapes_1 = [];\n      var addShapes_1 = function (item) {\n        if (!item) {\n          return;\n        }\n        if (item.isGroup()) {\n          item.getChildren().forEach(function (child) {\n            return addShapes_1(child);\n          });\n        } else {\n          shapes_1.push(item);\n        }\n      };\n      each(geometries, function (geom) {\n        if (apply_1) {\n          if (contains(apply_1, geom.type)) {\n            each(geom.elements, function (elem) {\n              addShapes_1(elem.shape);\n            });\n          }\n        } else {\n          each(geom.elements, function (elem) {\n            addShapes_1(elem.shape);\n          });\n        }\n      });\n      o = __assign(__assign({}, rest), {\n        color: color,\n        shapes: shapes_1,\n        start: sp,\n        end: ep\n      });\n    } else if (type === 'shape') {\n      var _j = option,\n        render_1 = _j.render,\n        restOptions = __rest(_j, [\"render\"]);\n      var wrappedRender = function (container) {\n        if (isFunction(option.render)) {\n          return render_1(container, _this.view, {\n            parsePosition: _this.parsePosition.bind(_this)\n          });\n        }\n      };\n      o = __assign(__assign({}, restOptions), {\n        render: wrappedRender\n      });\n    } else if (type === 'html') {\n      var _k = option,\n        html_1 = _k.html,\n        position_3 = _k.position,\n        restOptions = __rest(_k, [\"html\", \"position\"]);\n      var wrappedHtml = function (container) {\n        if (isFunction(html_1)) {\n          return html_1(container, _this.view);\n        }\n        return html_1;\n      };\n      o = __assign(__assign(__assign({}, restOptions), textPoint), {\n        // html 组件需要指定 parent\n        parent: canvas.get('el').parentNode,\n        html: wrappedHtml\n      });\n    }\n    // 合并主题，用户配置优先级高于默认主题\n    var cfg = deepMix({}, theme, __assign(__assign({}, o), {\n      top: option.top,\n      style: option.style,\n      offsetX: option.offsetX,\n      offsetY: option.offsetY\n    }));\n    if (type !== 'html') {\n      // html 类型不使用 G container\n      cfg.container = this.getComponentContainer(cfg);\n    }\n    cfg.animate = this.view.getOptions().animate && cfg.animate && get(option, 'animate', cfg.animate); // 如果 view 关闭动画，则不执行\n    cfg.animateOption = deepMix({}, DEFAULT_ANIMATE_CFG, cfg.animateOption, option.animateOption);\n    return cfg;\n  };\n  /**\n   * is annotation render on top\n   * @param option\n   * @return whethe on top\n   */\n  Annotation.prototype.isTop = function (option) {\n    return get(option, 'top', true);\n  };\n  /**\n   * get the container by option.top\n   * default is on top\n   * @param option\n   * @returns the container\n   */\n  Annotation.prototype.getComponentContainer = function (option) {\n    return this.isTop(option) ? this.foregroundContainer : this.backgroundContainer;\n  };\n  Annotation.prototype.getAnnotationTheme = function (type) {\n    return get(this.view.getTheme(), ['components', 'annotation', type], {});\n  };\n  /**\n   * 创建或者更新 annotation\n   * @param option\n   */\n  Annotation.prototype.updateOrCreate = function (option) {\n    // 拿到缓存的内容\n    var co = this.cache.get(this.getCacheKey(option));\n    // 存在则更新，不存在在创建\n    if (co) {\n      var type = option.type;\n      var theme = this.getAnnotationTheme(type);\n      var cfg = this.getAnnotationCfg(type, option, theme);\n      // 忽略掉一些配置\n      if (cfg) {\n        omit(cfg, ['container']);\n      }\n      co.component.update(__assign(__assign({}, cfg || {}), {\n        visible: !!cfg\n      }));\n      // 对于 regionFilter/shape，因为生命周期的原因，需要额外 render\n      if (includes(ANNOTATIONS_AFTER_RENDER, option.type)) {\n        co.component.render();\n      }\n    } else {\n      // 不存在，创建\n      co = this.createAnnotation(option);\n      if (co) {\n        co.component.init();\n        // Note：regionFilter/shape 特殊处理，regionFilter/shape 需要取到 Geometry 中的 Shape，需要在 view render 之后处理\n        // 其他组件使用外层的统一 render 逻辑\n        if (includes(ANNOTATIONS_AFTER_RENDER, option.type)) {\n          co.component.render();\n        }\n      }\n    }\n    return co;\n  };\n  /**\n   * 更新缓存，以及销毁组件\n   * @param updated 更新或者创建的组件\n   */\n  Annotation.prototype.syncCache = function (updated) {\n    var _this = this;\n    var newCache = new Map(this.cache); // clone 一份\n    // 将 update 更新到 cache\n    updated.forEach(function (co, key) {\n      newCache.set(key, co);\n    });\n    // 另外和 options 进行对比，删除\n    newCache.forEach(function (co, key) {\n      // option 中已经找不到，那么就是删除的\n      if (!find(_this.option, function (option) {\n        return key === _this.getCacheKey(option);\n      })) {\n        co.component.destroy();\n        newCache.delete(key);\n      }\n    });\n    return newCache;\n  };\n  /**\n   * 获得缓存组件的 key\n   * @param option\n   */\n  Annotation.prototype.getCacheKey = function (option) {\n    // 如果存在 id，则使用 id string，否则直接使用 option 引用作为 key\n    return option;\n    // 后续扩展 id 用\n    // const id = get(option, 'id');\n    // return id ? id : option;\n  };\n\n  return Annotation;\n}(Controller);\nexport default Annotation;","map":{"version":3,"names":["contains","deepMix","each","get","isArray","isFunction","isNil","isString","keys","upperFirst","find","includes","Annotation","AnnotationComponent","DEFAULT_ANIMATE_CFG","COMPONENT_TYPE","DIRECTION","GEOMETRY_LIFE_CIRCLE","LAYER","VIEW_LIFE_CIRCLE","getAngleByPoint","getDistanceToCenter","omit","getNormalizedValue","Controller","ANNOTATIONS_AFTER_RENDER","_super","__extends","view","_this","call","cache","Map","foregroundContainer","getLayer","FORE","addGroup","backgroundContainer","BG","option","Object","defineProperty","prototype","init","layout","update","render","onAfterRender","updated","type","co","updateOrCreate","set","getCacheKey","syncCache","updateCache","clear","includeOption","clearComponents","destroy","remove","getComponents","forEach","value","push","component","doWhat","done","getOptions","animate","geometries","g","animateOption","once","AFTER_DRAW_ANIMATE","getRootView","AFTER_RENDER","createAnnotation","Ctor","theme","getAnnotationTheme","cfg","getAnnotationCfg","annotation","layer","isTop","direction","NONE","ANNOTATION","extra","arc","__assign","image","line","region","text","dataMarker","dataRegion","regionFilter","shape","html","parsePosition","p","xScale","getXScale","yScales","getScalesByDim","position","x","y","_b","__read","xPos","yPos","indexOf","isNaN","slice","parsePercentPosition","values","_c","__values","_d","next","key","field","getCoordinate","convert","getRegionPoints","start","end","yScale","xField","viewData","getData","startXValue","endXValue","arr","startIndex","item","idx","point","xPercent","parseFloat","yPercent","coordinate","topLeft","Math","min","getWidth","getHeight","getCoordinateBBox","width","height","minX","minY","maxX","maxY","canvas","getCanvas","o","sp","ep","textPoint","_a","start_1","end_1","rest","__rest","startAngle","endAngle","PI","center","getCenter","radius","start_2","end_2","src","start_3","end_3","start_4","end_4","filteredData","_e","position_1","content","textContent","_f","position_2","autoAdjust","coordinateBBox","_g","start_5","end_5","lineLength","points","_h","start_6","end_6","apply_1","apply","color","shapes_1","addShapes_1","isGroup","getChildren","child","geom","elements","elem","shapes","_j","render_1","restOptions","wrappedRender","container","bind","_k","html_1","position_3","wrappedHtml","parent","parentNode","top","style","offsetX","offsetY","getComponentContainer","getTheme","visible","newCache","delete"],"sources":["../../../src/chart/controller/annotation.ts"],"sourcesContent":["import {\n  contains,\n  deepMix,\n  each,\n  get,\n  isArray,\n  isFunction,\n  isNil,\n  isString,\n  keys,\n  upperFirst,\n  find,\n  includes,\n} from '@antv/util';\nimport { Annotation as AnnotationComponent, IElement, IGroup } from '../../dependents';\nimport {\n  AnnotationBaseOption as BaseOption,\n  AnnotationPosition as Position,\n  ArcOption,\n  ComponentOption,\n  ShapeAnnotationOption,\n  Data,\n  DataMarkerOption,\n  DataRegionOption,\n  Datum,\n  HtmlAnnotationOption,\n  ImageOption,\n  LineOption,\n  Point,\n  RegionFilterOption,\n  RegionOption,\n  RegionPositionBaseOption,\n  TextOption,\n} from '../../interface';\n\nimport { DEFAULT_ANIMATE_CFG } from '../../animate/';\nimport { COMPONENT_TYPE, DIRECTION, GEOMETRY_LIFE_CIRCLE, LAYER, VIEW_LIFE_CIRCLE } from '../../constant';\n\nimport Geometry from '../../geometry/base';\nimport Element from '../../geometry/element';\nimport { getAngleByPoint, getDistanceToCenter } from '../../util/coordinate';\nimport { omit } from '../../util/helper';\nimport { getNormalizedValue } from '../../util/annotation';\nimport View from '../view';\nimport { Controller } from './base';\nimport { Scale } from '@antv/attr';\n\n/** 需要在图形绘制完成后才渲染的辅助组件类型列表 */\nconst ANNOTATIONS_AFTER_RENDER = ['regionFilter', 'shape'];\n\n/**\n * Annotation controller, 主要作用:\n * 1. 创建 Annotation: line、text、arc ...\n * 2. 生命周期: init、layout、render、clear、destroy\n */\nexport default class Annotation extends Controller<BaseOption[]> {\n  private foregroundContainer: IGroup;\n  private backgroundContainer: IGroup;\n\n  /* 组件更新的 cache，组件配置 object : 组件 */\n  private cache = new Map<BaseOption, ComponentOption>();\n\n  constructor(view: View) {\n    super(view);\n\n    this.foregroundContainer = this.view.getLayer(LAYER.FORE).addGroup();\n    this.backgroundContainer = this.view.getLayer(LAYER.BG).addGroup();\n\n    this.option = [];\n  }\n\n  public get name(): string {\n    return 'annotation';\n  }\n\n  public init() { }\n\n  /**\n   * 因为 annotation 需要依赖坐标系信息，所以 render 阶段为空方法，实际的创建逻辑都在 layout 中\n   */\n  public layout() {\n    this.update();\n  }\n\n  // 因为 Annotation 不参与布局，但是渲染的位置依赖于坐标系，所以可以将绘制阶段延迟到 layout() 进行\n  public render() { }\n\n  /**\n   * 更新\n   */\n  public update() {\n    // 1. 先处理需要在图形渲染之后的辅助组件 需要在 Geometry 完成之后，拿到图形信息\n    this.onAfterRender(() => {\n      const updated = new Map<BaseOption, ComponentOption>();\n      // 先看是否有 regionFilter/shape 要更新\n      each(this.option, (option: BaseOption) => {\n        if (includes(ANNOTATIONS_AFTER_RENDER, option.type)) {\n          const co = this.updateOrCreate(option);\n          // 存储已经处理过的\n          if (co) {\n            updated.set(this.getCacheKey(option), co);\n          }\n        }\n      });\n\n      // 处理完成之后，更新 cache\n      // 处理完成之后，销毁删除的\n      this.cache = this.syncCache(updated);\n    });\n\n    // 2. 处理非 regionFilter\n    const updateCache = new Map<BaseOption, ComponentOption>();\n    each(this.option, (option: BaseOption) => {\n      if (!includes(ANNOTATIONS_AFTER_RENDER, option.type)) {\n        const co = this.updateOrCreate(option);\n        // 存储已经处理过的\n        if (co) {\n          updateCache.set(this.getCacheKey(option), co);\n        }\n      }\n    });\n    this.cache = this.syncCache(updateCache);\n  }\n\n  /**\n   * 清空\n   * @param includeOption 是否清空 option 配置项\n   */\n  public clear(includeOption = false) {\n    super.clear();\n\n    this.clearComponents();\n    this.foregroundContainer.clear();\n    this.backgroundContainer.clear();\n\n    // clear all option\n    if (includeOption) {\n      this.option = [];\n    }\n  }\n\n  public destroy() {\n    this.clear(true);\n\n    this.foregroundContainer.remove(true);\n    this.backgroundContainer.remove(true);\n  }\n\n  /**\n   * 复写基类的方法\n   */\n  public getComponents(): ComponentOption[] {\n    const co = [];\n\n    this.cache.forEach((value: ComponentOption) => {\n      co.push(value);\n    });\n\n    return co;\n  }\n\n  /**\n   * 清除当前的组件\n   */\n  private clearComponents() {\n    this.getComponents().forEach((co) => {\n      co.component.destroy();\n    });\n\n    this.cache.clear();\n  }\n\n  /**\n   * region filter 比较特殊的渲染时机\n   * @param doWhat\n   */\n  private onAfterRender(doWhat: () => void) {\n    let done = false;\n    if (this.view.getOptions().animate) {\n      this.view.geometries.forEach((g: Geometry) => {\n        // 如果 geometry 开启，则监听\n        if (g.animateOption) {\n          g.once(GEOMETRY_LIFE_CIRCLE.AFTER_DRAW_ANIMATE, () => {\n          doWhat();\n          });\n          done = true;\n        }\n      });\n    }\n\n    if (!done) {\n      this.view.getRootView().once(VIEW_LIFE_CIRCLE.AFTER_RENDER, () => {\n        doWhat();\n      });\n    }\n  }\n\n  private createAnnotation(option: BaseOption) {\n    const { type } = option;\n\n    const Ctor = AnnotationComponent[upperFirst(type)];\n    if (Ctor) {\n      const theme = this.getAnnotationTheme(type);\n      const cfg = this.getAnnotationCfg(type, option, theme);\n      // 不创建\n      if (!cfg) {\n        return null;\n      }\n      const annotation = new Ctor(cfg);\n\n      return {\n        component: annotation,\n        layer: this.isTop(cfg) ? LAYER.FORE : LAYER.BG,\n        direction: DIRECTION.NONE,\n        type: COMPONENT_TYPE.ANNOTATION,\n        extra: option,\n      };\n    }\n  }\n\n  // APIs for creating annotation component\n  public annotation(option: any) {\n    this.option.push(option);\n  }\n\n  /**\n   * 创建 Arc\n   * @param option\n   * @returns AnnotationController\n   */\n  public arc(option: ArcOption) {\n    this.annotation({\n      type: 'arc',\n      ...option,\n    });\n\n    return this;\n  }\n\n  /**\n   * 创建 image\n   * @param option\n   * @returns AnnotationController\n   */\n  public image(option: ImageOption) {\n    this.annotation({\n      type: 'image',\n      ...option,\n    });\n\n    return this;\n  }\n\n  /**\n   * 创建 Line\n   * @param option\n   * @returns AnnotationController\n   */\n  public line(option: LineOption) {\n    this.annotation({\n      type: 'line',\n      ...option,\n    });\n\n    return this;\n  }\n\n  /**\n   * 创建 Region\n   * @param option\n   * @returns AnnotationController\n   */\n  public region(option: RegionOption) {\n    this.annotation({\n      type: 'region',\n      ...option,\n    });\n\n    return this;\n  }\n\n  /**\n   * 创建 Text\n   * @param option\n   * @returns AnnotationController\n   */\n  public text(option: TextOption) {\n    this.annotation({\n      type: 'text',\n      ...option,\n    });\n\n    return this;\n  }\n\n  /**\n   * 创建 DataMarker\n   * @param option\n   * @returns AnnotationController\n   */\n  public dataMarker(option: DataMarkerOption) {\n    this.annotation({\n      type: 'dataMarker',\n      ...option,\n    });\n\n    return this;\n  }\n\n  /**\n   * 创建 DataRegion\n   * @param option\n   * @returns AnnotationController\n   */\n  public dataRegion(option: DataRegionOption) {\n    this.annotation({\n      type: 'dataRegion',\n      ...option,\n    });\n  }\n\n  /**\n   * 创建 RegionFilter\n   * @param option\n   * @returns AnnotationController\n   */\n  public regionFilter(option: RegionFilterOption) {\n    this.annotation({\n      type: 'regionFilter',\n      ...option,\n    });\n  }\n\n  /**\n   * 创建 ShapeAnnotation\n   * @param option\n   */\n  public shape(option: ShapeAnnotationOption) {\n    this.annotation({\n      type: 'shape',\n      ...option,\n    });\n  }\n\n  /**\n   * 创建 HtmlAnnotation\n   * @param option\n   */\n  public html(option: HtmlAnnotationOption) {\n    this.annotation({\n      type: 'html',\n      ...option,\n    });\n  }\n  // end API\n\n  /**\n   * parse the point position to [x, y]\n   * @param p Position\n   * @returns { x, y }\n   */\n  private parsePosition(\n    p:\n      | [string | number, string | number]\n      | Datum\n      | ((xScale: Scale, yScale: Scale) => [string | number, string | number] | number | Datum)\n  ): Point {\n    const xScale = this.view.getXScale();\n    // 转成 object\n    const yScales = this.view.getScalesByDim('y');\n\n    const position: Position = isFunction(p) ? p.call(null, xScale, yScales) : p;\n\n    let x = 0;\n    let y = 0;\n\n    // 入参是 [24, 24] 这类时\n    if (isArray(position)) {\n      const [xPos, yPos] = position;\n      // 如果数据格式是 ['50%', '50%'] 的格式\n      // fix: 原始数据中可能会包含 'xxx5%xxx' 这样的数据，需要判断下 https://github.com/antvis/f2/issues/590\n      // @ts-ignore\n      if (isString(xPos) && xPos.indexOf('%') !== -1 && !isNaN(xPos.slice(0, -1))) {\n        return this.parsePercentPosition(position as [string, string]);\n      }\n\n      x = getNormalizedValue(xPos, xScale);\n      y = getNormalizedValue(yPos, Object.values(yScales)[0]);\n    } else if (!isNil(position)) {\n      // 入参是 object 结构，数据点\n      for (const key of keys(position)) {\n        const value = position[key];\n        if (key === xScale.field) {\n          x = getNormalizedValue(value, xScale);\n        }\n        if (yScales[key]) {\n          y = getNormalizedValue(value, yScales[key]);\n        }\n      }\n    }\n\n    if (isNaN(x) || isNaN(y)) {\n      return null;\n    }\n\n    return this.view.getCoordinate().convert({ x, y });\n  }\n\n  /**\n   * parse all the points between start and end\n   * @param start\n   * @param end\n   * @return Point[]\n   */\n  private getRegionPoints(start: Position | Data, end: Position | Data): Point[] {\n    const xScale = this.view.getXScale();\n    const yScales = this.view.getScalesByDim('y');\n    const yScale = Object.values(yScales)[0];\n    const xField = xScale.field;\n    const viewData = this.view.getData();\n    const startXValue = isArray(start) ? start[0] : start[xField];\n    const endXValue = isArray(end) ? end[0] : end[xField];\n    const arr = [];\n\n    let startIndex;\n    each(viewData, (item, idx) => {\n      if (item[xField] === startXValue) {\n        startIndex = idx;\n      }\n      if (idx >= startIndex) {\n        const point = this.parsePosition([item[xField], item[yScale.field]]);\n        if (point) {\n          arr.push(point);\n        }\n      }\n      if (item[xField] === endXValue) {\n        return false;\n      }\n    });\n\n    return arr;\n  }\n\n  /**\n   * parse percent position\n   * @param position\n   */\n  private parsePercentPosition(position: [string, string]): Point {\n    const xPercent = parseFloat(position[0]) / 100;\n    const yPercent = parseFloat(position[1]) / 100;\n    const coordinate = this.view.getCoordinate();\n    const { start, end } = coordinate;\n\n    const topLeft = {\n      x: Math.min(start.x, end.x),\n      y: Math.min(start.y, end.y),\n    };\n    const x = coordinate.getWidth() * xPercent + topLeft.x;\n    const y = coordinate.getHeight() * yPercent + topLeft.y;\n    return { x, y };\n  }\n\n  /**\n   * get coordinate bbox\n   */\n  private getCoordinateBBox() {\n    const coordinate = this.view.getCoordinate();\n    const { start, end } = coordinate;\n\n    const width = coordinate.getWidth();\n    const height = coordinate.getHeight();\n    const topLeft = {\n      x: Math.min(start.x, end.x),\n      y: Math.min(start.y, end.y),\n    };\n\n    return {\n      x: topLeft.x,\n      y: topLeft.y,\n      minX: topLeft.x,\n      minY: topLeft.y,\n      maxX: topLeft.x + width,\n      maxY: topLeft.y + height,\n      width,\n      height,\n    };\n  }\n\n  /**\n   * get annotation component config by different type\n   * @param type\n   * @param option 用户的配置\n   * @param theme\n   */\n  private getAnnotationCfg(type: string, option: any, theme: object): object | null {\n    const coordinate = this.view.getCoordinate();\n    const canvas = this.view.getCanvas();\n    let o = {};\n\n    if (isNil(option)) {\n      return null;\n    }\n    const { start, end, position } = option;\n    const sp = this.parsePosition(start);\n    const ep = this.parsePosition(end);\n    const textPoint = this.parsePosition(position);\n    if (['arc', 'image', 'line', 'region', 'regionFilter'].includes(type) && (!sp || !ep)) {\n      return null;\n    } else if (['text', 'dataMarker', 'html'].includes(type) && !textPoint) {\n      return null;\n    }\n\n    if (type === 'arc') {\n      const { start, end, ...rest } = option as ArcOption;\n      const startAngle = getAngleByPoint(coordinate, sp);\n      let endAngle = getAngleByPoint(coordinate, ep);\n      if (startAngle > endAngle) {\n        endAngle = Math.PI * 2 + endAngle;\n      }\n\n      o = {\n        ...rest,\n        center: coordinate.getCenter(),\n        radius: getDistanceToCenter(coordinate, sp),\n        startAngle,\n        endAngle,\n      };\n    } else if (type === 'image') {\n      const { start, end, ...rest } = option as ImageOption;\n      o = {\n        ...rest,\n        start: sp,\n        end: ep,\n        src: option.src,\n      };\n    } else if (type === 'line') {\n      const { start, end, ...rest } = option as LineOption;\n      o = {\n        ...rest,\n        start: sp,\n        end: ep,\n        text: get(option, 'text', null),\n      };\n    } else if (type === 'region') {\n      const { start, end, ...rest } = option as RegionPositionBaseOption;\n      o = {\n        ...rest,\n        start: sp,\n        end: ep,\n      };\n    } else if (type === 'text') {\n      const filteredData = this.view.getData();\n      const { position, content, ...rest } = option as TextOption;\n      let textContent = content;\n      if (isFunction(content)) {\n        textContent = content(filteredData);\n      }\n      o = {\n        ...textPoint,\n        ...rest,\n        content: textContent,\n      };\n    } else if (type === 'dataMarker') {\n      const { position, point, line, text, autoAdjust, direction, ...rest } = option as DataMarkerOption;\n      o = {\n        ...rest,\n        ...textPoint,\n        coordinateBBox: this.getCoordinateBBox(),\n        point,\n        line,\n        text,\n        autoAdjust,\n        direction,\n      };\n    } else if (type === 'dataRegion') {\n      const { start, end, region, text, lineLength, ...rest } = option as DataRegionOption;\n      o = {\n        ...rest,\n        points: this.getRegionPoints(start, end),\n        region,\n        text,\n        lineLength,\n      };\n    } else if (type === 'regionFilter') {\n      const { start, end, apply, color, ...rest } = option as RegionFilterOption;\n      const geometries: Geometry[] = this.view.geometries;\n      const shapes = [];\n      const addShapes = (item?: IElement) => {\n        if (!item) {\n          return;\n        }\n        if (item.isGroup()) {\n          (item as IGroup).getChildren().forEach((child) => addShapes(child));\n        } else {\n          shapes.push(item);\n        }\n      };\n      each(geometries, (geom: Geometry) => {\n        if (apply) {\n          if (contains(apply, geom.type)) {\n            each(geom.elements, (elem: Element) => {\n              addShapes(elem.shape);\n            });\n          }\n        } else {\n          each(geom.elements, (elem: Element) => {\n            addShapes(elem.shape);\n          });\n        }\n      });\n      o = {\n        ...rest,\n        color,\n        shapes,\n        start: sp,\n        end: ep,\n      };\n    } else if (type === 'shape') {\n      const { render, ...restOptions } = option as ShapeAnnotationOption;\n      const wrappedRender = (container: IGroup) => {\n        if (isFunction(option.render)) {\n          return render(container, this.view, { parsePosition: this.parsePosition.bind(this) });\n        }\n      };\n      o = {\n        ...restOptions,\n        render: wrappedRender,\n      };\n    } else if (type === 'html') {\n      const { html, position, ...restOptions } = option as HtmlAnnotationOption;\n      const wrappedHtml = (container: HTMLElement) => {\n        if (isFunction(html)) {\n          return html(container, this.view);\n        }\n        return html;\n      };\n      o = {\n        ...restOptions,\n        ...textPoint,\n        // html 组件需要指定 parent\n        parent: canvas.get('el').parentNode,\n        html: wrappedHtml,\n      };\n    }\n    // 合并主题，用户配置优先级高于默认主题\n    const cfg = deepMix({}, theme, {\n      ...o,\n      top: option.top,\n      style: option.style,\n      offsetX: option.offsetX,\n      offsetY: option.offsetY,\n    });\n    if (type !== 'html') {\n      // html 类型不使用 G container\n      cfg.container = this.getComponentContainer(cfg);\n    }\n    cfg.animate = this.view.getOptions().animate && cfg.animate && get(option, 'animate', cfg.animate); // 如果 view 关闭动画，则不执行\n    cfg.animateOption = deepMix({}, DEFAULT_ANIMATE_CFG, cfg.animateOption, option.animateOption);\n\n    return cfg;\n  }\n\n  /**\n   * is annotation render on top\n   * @param option\n   * @return whethe on top\n   */\n  private isTop(option: any): boolean {\n    return get(option, 'top', true);\n  }\n\n  /**\n   * get the container by option.top\n   * default is on top\n   * @param option\n   * @returns the container\n   */\n  private getComponentContainer(option: any) {\n    return this.isTop(option) ? this.foregroundContainer : this.backgroundContainer;\n  }\n\n  private getAnnotationTheme(type: string) {\n    return get(this.view.getTheme(), ['components', 'annotation', type], {});\n  }\n\n  /**\n   * 创建或者更新 annotation\n   * @param option\n   */\n  private updateOrCreate(option: BaseOption) {\n    // 拿到缓存的内容\n    let co = this.cache.get(this.getCacheKey(option));\n\n    // 存在则更新，不存在在创建\n    if (co) {\n      const { type } = option;\n      const theme = this.getAnnotationTheme(type);\n      const cfg = this.getAnnotationCfg(type, option, theme);\n\n      // 忽略掉一些配置\n      if (cfg) {\n        omit(cfg, ['container']);\n      }\n      co.component.update({ ...(cfg || {}), visible: !!cfg });\n      // 对于 regionFilter/shape，因为生命周期的原因，需要额外 render\n      if (includes(ANNOTATIONS_AFTER_RENDER, option.type)) {\n        co.component.render();\n      }\n    } else {\n      // 不存在，创建\n      co = this.createAnnotation(option);\n      if (co) {\n        co.component.init();\n        // Note：regionFilter/shape 特殊处理，regionFilter/shape 需要取到 Geometry 中的 Shape，需要在 view render 之后处理\n        // 其他组件使用外层的统一 render 逻辑\n        if (includes(ANNOTATIONS_AFTER_RENDER, option.type)) {\n          co.component.render();\n        }\n      }\n    }\n    return co;\n  }\n\n  /**\n   * 更新缓存，以及销毁组件\n   * @param updated 更新或者创建的组件\n   */\n  private syncCache(updated: Map<BaseOption, ComponentOption>) {\n    const newCache = new Map(this.cache); // clone 一份\n\n    // 将 update 更新到 cache\n    updated.forEach((co: ComponentOption, key: BaseOption) => {\n      newCache.set(key, co);\n    });\n\n    // 另外和 options 进行对比，删除\n    newCache.forEach((co: ComponentOption, key: BaseOption) => {\n      // option 中已经找不到，那么就是删除的\n      if (\n        !find(this.option, (option: BaseOption) => {\n          return key === this.getCacheKey(option);\n        })\n      ) {\n        co.component.destroy();\n        newCache.delete(key);\n      }\n    });\n\n    return newCache;\n  }\n\n  /**\n   * 获得缓存组件的 key\n   * @param option\n   */\n  private getCacheKey(option: BaseOption) {\n    // 如果存在 id，则使用 id string，否则直接使用 option 引用作为 key\n    return option;\n    // 后续扩展 id 用\n    // const id = get(option, 'id');\n    // return id ? id : option;\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}