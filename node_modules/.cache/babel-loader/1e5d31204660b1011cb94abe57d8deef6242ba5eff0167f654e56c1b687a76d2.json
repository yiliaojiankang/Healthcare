{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.resolve = void 0;\nvar ERROR_MSGS = require(\"../constants/error_msgs\");\nvar literal_types_1 = require(\"../constants/literal_types\");\nvar exceptions_1 = require(\"../utils/exceptions\");\nvar serialization_1 = require(\"../utils/serialization\");\nvar instantiation_1 = require(\"./instantiation\");\nvar invokeFactory = function (factoryType, serviceIdentifier, fn) {\n  try {\n    return fn();\n  } catch (error) {\n    if (exceptions_1.isStackOverflowExeption(error)) {\n      throw new Error(ERROR_MSGS.CIRCULAR_DEPENDENCY_IN_FACTORY(factoryType, serviceIdentifier.toString()));\n    } else {\n      throw error;\n    }\n  }\n};\nvar _resolveRequest = function (requestScope) {\n  return function (request) {\n    request.parentContext.setCurrentRequest(request);\n    var bindings = request.bindings;\n    var childRequests = request.childRequests;\n    var targetIsAnArray = request.target && request.target.isArray();\n    var targetParentIsNotAnArray = !request.parentRequest || !request.parentRequest.target || !request.target || !request.parentRequest.target.matchesArray(request.target.serviceIdentifier);\n    if (targetIsAnArray && targetParentIsNotAnArray) {\n      return childRequests.map(function (childRequest) {\n        var _f = _resolveRequest(requestScope);\n        return _f(childRequest);\n      });\n    } else {\n      var result = null;\n      if (request.target.isOptional() && bindings.length === 0) {\n        return undefined;\n      }\n      var binding_1 = bindings[0];\n      var isSingleton = binding_1.scope === literal_types_1.BindingScopeEnum.Singleton;\n      var isRequestSingleton = binding_1.scope === literal_types_1.BindingScopeEnum.Request;\n      if (isSingleton && binding_1.activated) {\n        return binding_1.cache;\n      }\n      if (isRequestSingleton && requestScope !== null && requestScope.has(binding_1.id)) {\n        return requestScope.get(binding_1.id);\n      }\n      if (binding_1.type === literal_types_1.BindingTypeEnum.ConstantValue) {\n        result = binding_1.cache;\n        binding_1.activated = true;\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.Function) {\n        result = binding_1.cache;\n        binding_1.activated = true;\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.Constructor) {\n        result = binding_1.implementationType;\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.DynamicValue && binding_1.dynamicValue !== null) {\n        result = invokeFactory(\"toDynamicValue\", binding_1.serviceIdentifier, function () {\n          return binding_1.dynamicValue(request.parentContext);\n        });\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.Factory && binding_1.factory !== null) {\n        result = invokeFactory(\"toFactory\", binding_1.serviceIdentifier, function () {\n          return binding_1.factory(request.parentContext);\n        });\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.Provider && binding_1.provider !== null) {\n        result = invokeFactory(\"toProvider\", binding_1.serviceIdentifier, function () {\n          return binding_1.provider(request.parentContext);\n        });\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.Instance && binding_1.implementationType !== null) {\n        result = instantiation_1.resolveInstance(binding_1.implementationType, childRequests, _resolveRequest(requestScope));\n      } else {\n        var serviceIdentifier = serialization_1.getServiceIdentifierAsString(request.serviceIdentifier);\n        throw new Error(ERROR_MSGS.INVALID_BINDING_TYPE + \" \" + serviceIdentifier);\n      }\n      if (typeof binding_1.onActivation === \"function\") {\n        result = binding_1.onActivation(request.parentContext, result);\n      }\n      if (isSingleton) {\n        binding_1.cache = result;\n        binding_1.activated = true;\n      }\n      if (isRequestSingleton && requestScope !== null && !requestScope.has(binding_1.id)) {\n        requestScope.set(binding_1.id, result);\n      }\n      return result;\n    }\n  };\n};\nfunction resolve(context) {\n  var _f = _resolveRequest(context.plan.rootRequest.requestScope);\n  return _f(context.plan.rootRequest);\n}\nexports.resolve = resolve;","map":{"version":3,"names":["ERROR_MSGS","require","literal_types_1","exceptions_1","serialization_1","instantiation_1","invokeFactory","factoryType","serviceIdentifier","fn","error","isStackOverflowExeption","Error","CIRCULAR_DEPENDENCY_IN_FACTORY","toString","_resolveRequest","requestScope","request","parentContext","setCurrentRequest","bindings","childRequests","targetIsAnArray","target","isArray","targetParentIsNotAnArray","parentRequest","matchesArray","map","childRequest","_f","result","isOptional","length","undefined","binding_1","isSingleton","scope","BindingScopeEnum","Singleton","isRequestSingleton","Request","activated","cache","has","id","get","type","BindingTypeEnum","ConstantValue","Function","Constructor","implementationType","DynamicValue","dynamicValue","Factory","factory","Provider","provider","Instance","resolveInstance","getServiceIdentifierAsString","INVALID_BINDING_TYPE","onActivation","set","resolve","context","plan","rootRequest","exports"],"sources":["../../src/resolution/resolver.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}