{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { get, isFunction, isNumber, map, maxBy } from '@antv/util';\nimport { FUNNEL_CONVERSATION, FUNNEL_MAPPING_VALUE, FUNNEL_PERCENT } from '../constant';\nexport var CONVERSION_TAG_NAME = 'CONVERSION_TAG_NAME';\n/**\n * 漏斗图 transform\n * @param geometry\n */\nexport function transformData(data, originData, options) {\n  var formatData = [];\n  var yField = options.yField,\n    maxSize = options.maxSize,\n    minSize = options.minSize;\n  var maxYFieldValue = get(maxBy(originData, yField), [yField]);\n  var max = isNumber(maxSize) ? maxSize : 1;\n  var min = isNumber(minSize) ? minSize : 0;\n  // format 数据\n  formatData = map(data, function (row, index) {\n    var percent = (row[yField] || 0) / maxYFieldValue;\n    row[FUNNEL_PERCENT] = percent;\n    row[FUNNEL_MAPPING_VALUE] = (max - min) * percent + min;\n    // 转化率数据存储前后数据\n    row[FUNNEL_CONVERSATION] = [get(data, [index - 1, yField]), row[yField]];\n    return row;\n  });\n  return formatData;\n}\n/**\n * 漏斗图通用转化率组件\n * @param getLineCoordinate 用于获取特定的 line 的位置及配置\n */\nexport function conversionTagComponent(getLineCoordinate) {\n  return function (params) {\n    var chart = params.chart,\n      options = params.options;\n    // @ts-ignore\n    var conversionTag = options.conversionTag,\n      filteredData = options.filteredData;\n    var data = filteredData || chart.getOptions().data;\n    if (conversionTag) {\n      var formatter_1 = conversionTag.formatter;\n      data.forEach(function (obj, index) {\n        if (index <= 0 || Number.isNaN(obj[FUNNEL_MAPPING_VALUE])) return;\n        var lineOption = getLineCoordinate(obj, index, data, {\n          top: true,\n          name: CONVERSION_TAG_NAME,\n          text: {\n            content: isFunction(formatter_1) ? formatter_1(obj, data) : formatter_1,\n            offsetX: conversionTag.offsetX,\n            offsetY: conversionTag.offsetY,\n            position: 'end',\n            autoRotate: false,\n            style: __assign({\n              textAlign: 'start',\n              textBaseline: 'middle'\n            }, conversionTag.style)\n          }\n        });\n        chart.annotation().line(lineOption);\n      });\n    }\n    return params;\n  };\n}","map":{"version":3,"names":["get","isFunction","isNumber","map","maxBy","FUNNEL_CONVERSATION","FUNNEL_MAPPING_VALUE","FUNNEL_PERCENT","CONVERSION_TAG_NAME","transformData","data","originData","options","formatData","yField","maxSize","minSize","maxYFieldValue","max","min","row","index","percent","conversionTagComponent","getLineCoordinate","params","chart","conversionTag","filteredData","getOptions","formatter_1","formatter","forEach","obj","Number","isNaN","lineOption","top","name","text","content","offsetX","offsetY","position","autoRotate","style","__assign","textAlign","textBaseline","annotation","line"],"sources":["../../../../src/plots/funnel/geometries/common.ts"],"sourcesContent":["import { Types } from '@antv/g2';\nimport { get, isFunction, isNumber, map, maxBy } from '@antv/util';\nimport { Params } from '../../../core/adaptor';\nimport { Data, Datum } from '../../../types/common';\nimport { FUNNEL_CONVERSATION, FUNNEL_MAPPING_VALUE, FUNNEL_PERCENT } from '../constant';\nimport { FunnelOptions } from '../types';\n\nexport const CONVERSION_TAG_NAME = 'CONVERSION_TAG_NAME';\n\n/**\n * 漏斗图 transform\n * @param geometry\n */\nexport function transformData(\n  data: FunnelOptions['data'],\n  originData: FunnelOptions['data'],\n  options: Pick<FunnelOptions, 'yField' | 'maxSize' | 'minSize'>\n): FunnelOptions['data'] {\n  let formatData = [];\n  const { yField, maxSize, minSize } = options;\n  const maxYFieldValue = get(maxBy(originData, yField), [yField]);\n  const max = isNumber(maxSize) ? maxSize : 1;\n  const min = isNumber(minSize) ? minSize : 0;\n\n  // format 数据\n  formatData = map(data, (row, index) => {\n    const percent = (row[yField] || 0) / maxYFieldValue;\n    row[FUNNEL_PERCENT] = percent;\n    row[FUNNEL_MAPPING_VALUE] = (max - min) * percent + min;\n    // 转化率数据存储前后数据\n    row[FUNNEL_CONVERSATION] = [get(data, [index - 1, yField]), row[yField]];\n    return row;\n  });\n\n  return formatData;\n}\n\n/**\n * 漏斗图通用转化率组件\n * @param getLineCoordinate 用于获取特定的 line 的位置及配置\n */\nexport function conversionTagComponent(\n  getLineCoordinate: (\n    datum: Datum,\n    datumIndex: number,\n    data: Data,\n    initLineOption: Record<string, any>\n  ) => Types.LineOption\n) {\n  return function (params: Params<FunnelOptions>): Params<FunnelOptions> {\n    const { chart, options } = params;\n    // @ts-ignore\n    const { conversionTag, filteredData } = options;\n\n    const data = filteredData || chart.getOptions().data;\n    if (conversionTag) {\n      const { formatter } = conversionTag;\n      data.forEach((obj, index) => {\n        if (index <= 0 || Number.isNaN(obj[FUNNEL_MAPPING_VALUE])) return;\n        const lineOption = getLineCoordinate(obj, index, data, {\n          top: true,\n          name: CONVERSION_TAG_NAME,\n          text: {\n            content: isFunction(formatter) ? formatter(obj, data) : formatter,\n            offsetX: conversionTag.offsetX,\n            offsetY: conversionTag.offsetY,\n            position: 'end',\n            autoRotate: false,\n            style: {\n              textAlign: 'start',\n              textBaseline: 'middle',\n              ...conversionTag.style,\n            },\n          },\n        });\n\n        chart.annotation().line(lineOption);\n      });\n    }\n    return params;\n  };\n}\n"],"mappings":";AACA,SAASA,GAAG,EAAEC,UAAU,EAAEC,QAAQ,EAAEC,GAAG,EAAEC,KAAK,QAAQ,YAAY;AAGlE,SAASC,mBAAmB,EAAEC,oBAAoB,EAAEC,cAAc,QAAQ,aAAa;AAGvF,OAAO,IAAMC,mBAAmB,GAAG,qBAAqB;AAExD;;;;AAIA,OAAM,SAAUC,aAAaA,CAC3BC,IAA2B,EAC3BC,UAAiC,EACjCC,OAA8D;EAE9D,IAAIC,UAAU,GAAG,EAAE;EACX,IAAAC,MAAM,GAAuBF,OAAO,CAAAE,MAA9B;IAAEC,OAAO,GAAcH,OAAO,CAAAG,OAArB;IAAEC,OAAO,GAAKJ,OAAO,CAAAI,OAAZ;EAChC,IAAMC,cAAc,GAAGjB,GAAG,CAACI,KAAK,CAACO,UAAU,EAAEG,MAAM,CAAC,EAAE,CAACA,MAAM,CAAC,CAAC;EAC/D,IAAMI,GAAG,GAAGhB,QAAQ,CAACa,OAAO,CAAC,GAAGA,OAAO,GAAG,CAAC;EAC3C,IAAMI,GAAG,GAAGjB,QAAQ,CAACc,OAAO,CAAC,GAAGA,OAAO,GAAG,CAAC;EAE3C;EACAH,UAAU,GAAGV,GAAG,CAACO,IAAI,EAAE,UAACU,GAAG,EAAEC,KAAK;IAChC,IAAMC,OAAO,GAAG,CAACF,GAAG,CAACN,MAAM,CAAC,IAAI,CAAC,IAAIG,cAAc;IACnDG,GAAG,CAACb,cAAc,CAAC,GAAGe,OAAO;IAC7BF,GAAG,CAACd,oBAAoB,CAAC,GAAG,CAACY,GAAG,GAAGC,GAAG,IAAIG,OAAO,GAAGH,GAAG;IACvD;IACAC,GAAG,CAACf,mBAAmB,CAAC,GAAG,CAACL,GAAG,CAACU,IAAI,EAAE,CAACW,KAAK,GAAG,CAAC,EAAEP,MAAM,CAAC,CAAC,EAAEM,GAAG,CAACN,MAAM,CAAC,CAAC;IACxE,OAAOM,GAAG;EACZ,CAAC,CAAC;EAEF,OAAOP,UAAU;AACnB;AAEA;;;;AAIA,OAAM,SAAUU,sBAAsBA,CACpCC,iBAKqB;EAErB,OAAO,UAAUC,MAA6B;IACpC,IAAAC,KAAK,GAAcD,MAAM,CAAAC,KAApB;MAAEd,OAAO,GAAKa,MAAM,CAAAb,OAAX;IACtB;IACQ,IAAAe,aAAa,GAAmBf,OAAO,CAAAe,aAA1B;MAAEC,YAAY,GAAKhB,OAAO,CAAAgB,YAAZ;IAEnC,IAAMlB,IAAI,GAAGkB,YAAY,IAAIF,KAAK,CAACG,UAAU,EAAE,CAACnB,IAAI;IACpD,IAAIiB,aAAa,EAAE;MACT,IAAAG,WAAS,GAAKH,aAAa,CAAAI,SAAlB;MACjBrB,IAAI,CAACsB,OAAO,CAAC,UAACC,GAAG,EAAEZ,KAAK;QACtB,IAAIA,KAAK,IAAI,CAAC,IAAIa,MAAM,CAACC,KAAK,CAACF,GAAG,CAAC3B,oBAAoB,CAAC,CAAC,EAAE;QAC3D,IAAM8B,UAAU,GAAGZ,iBAAiB,CAACS,GAAG,EAAEZ,KAAK,EAAEX,IAAI,EAAE;UACrD2B,GAAG,EAAE,IAAI;UACTC,IAAI,EAAE9B,mBAAmB;UACzB+B,IAAI,EAAE;YACJC,OAAO,EAAEvC,UAAU,CAAC6B,WAAS,CAAC,GAAGA,WAAS,CAACG,GAAG,EAAEvB,IAAI,CAAC,GAAGoB,WAAS;YACjEW,OAAO,EAAEd,aAAa,CAACc,OAAO;YAC9BC,OAAO,EAAEf,aAAa,CAACe,OAAO;YAC9BC,QAAQ,EAAE,KAAK;YACfC,UAAU,EAAE,KAAK;YACjBC,KAAK,EAAAC,QAAA;cACHC,SAAS,EAAE,OAAO;cAClBC,YAAY,EAAE;YAAQ,GACnBrB,aAAa,CAACkB,KAAK;;SAG3B,CAAC;QAEFnB,KAAK,CAACuB,UAAU,EAAE,CAACC,IAAI,CAACd,UAAU,CAAC;MACrC,CAAC,CAAC;;IAEJ,OAAOX,MAAM;EACf,CAAC;AACH"},"metadata":{},"sourceType":"module","externalDependencies":[]}