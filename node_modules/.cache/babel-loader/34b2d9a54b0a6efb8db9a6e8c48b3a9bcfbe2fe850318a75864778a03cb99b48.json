{"ast":null,"code":"\"use strict\";\n\nrequire(\"core-js/modules/es.array.push.js\");\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getBindingDictionary = exports.createMockRequest = exports.plan = void 0;\nvar binding_count_1 = require(\"../bindings/binding_count\");\nvar ERROR_MSGS = require(\"../constants/error_msgs\");\nvar literal_types_1 = require(\"../constants/literal_types\");\nvar METADATA_KEY = require(\"../constants/metadata_keys\");\nvar exceptions_1 = require(\"../utils/exceptions\");\nvar serialization_1 = require(\"../utils/serialization\");\nvar context_1 = require(\"./context\");\nvar metadata_1 = require(\"./metadata\");\nvar plan_1 = require(\"./plan\");\nvar reflection_utils_1 = require(\"./reflection_utils\");\nvar request_1 = require(\"./request\");\nvar target_1 = require(\"./target\");\nfunction getBindingDictionary(cntnr) {\n  return cntnr._bindingDictionary;\n}\nexports.getBindingDictionary = getBindingDictionary;\nfunction _createTarget(isMultiInject, targetType, serviceIdentifier, name, key, value) {\n  var metadataKey = isMultiInject ? METADATA_KEY.MULTI_INJECT_TAG : METADATA_KEY.INJECT_TAG;\n  var injectMetadata = new metadata_1.Metadata(metadataKey, serviceIdentifier);\n  var target = new target_1.Target(targetType, name, serviceIdentifier, injectMetadata);\n  if (key !== undefined) {\n    var tagMetadata = new metadata_1.Metadata(key, value);\n    target.metadata.push(tagMetadata);\n  }\n  return target;\n}\nfunction _getActiveBindings(metadataReader, avoidConstraints, context, parentRequest, target) {\n  var bindings = getBindings(context.container, target.serviceIdentifier);\n  var activeBindings = [];\n  if (bindings.length === binding_count_1.BindingCount.NoBindingsAvailable && context.container.options.autoBindInjectable && typeof target.serviceIdentifier === \"function\" && metadataReader.getConstructorMetadata(target.serviceIdentifier).compilerGeneratedMetadata) {\n    context.container.bind(target.serviceIdentifier).toSelf();\n    bindings = getBindings(context.container, target.serviceIdentifier);\n  }\n  if (!avoidConstraints) {\n    activeBindings = bindings.filter(function (binding) {\n      var request = new request_1.Request(binding.serviceIdentifier, context, parentRequest, binding, target);\n      return binding.constraint(request);\n    });\n  } else {\n    activeBindings = bindings;\n  }\n  _validateActiveBindingCount(target.serviceIdentifier, activeBindings, target, context.container);\n  return activeBindings;\n}\nfunction _validateActiveBindingCount(serviceIdentifier, bindings, target, container) {\n  switch (bindings.length) {\n    case binding_count_1.BindingCount.NoBindingsAvailable:\n      if (target.isOptional()) {\n        return bindings;\n      } else {\n        var serviceIdentifierString = serialization_1.getServiceIdentifierAsString(serviceIdentifier);\n        var msg = ERROR_MSGS.NOT_REGISTERED;\n        msg += serialization_1.listMetadataForTarget(serviceIdentifierString, target);\n        msg += serialization_1.listRegisteredBindingsForServiceIdentifier(container, serviceIdentifierString, getBindings);\n        throw new Error(msg);\n      }\n    case binding_count_1.BindingCount.OnlyOneBindingAvailable:\n      if (!target.isArray()) {\n        return bindings;\n      }\n    case binding_count_1.BindingCount.MultipleBindingsAvailable:\n    default:\n      if (!target.isArray()) {\n        var serviceIdentifierString = serialization_1.getServiceIdentifierAsString(serviceIdentifier);\n        var msg = ERROR_MSGS.AMBIGUOUS_MATCH + \" \" + serviceIdentifierString;\n        msg += serialization_1.listRegisteredBindingsForServiceIdentifier(container, serviceIdentifierString, getBindings);\n        throw new Error(msg);\n      } else {\n        return bindings;\n      }\n  }\n}\nfunction _createSubRequests(metadataReader, avoidConstraints, serviceIdentifier, context, parentRequest, target) {\n  var activeBindings;\n  var childRequest;\n  if (parentRequest === null) {\n    activeBindings = _getActiveBindings(metadataReader, avoidConstraints, context, null, target);\n    childRequest = new request_1.Request(serviceIdentifier, context, null, activeBindings, target);\n    var thePlan = new plan_1.Plan(context, childRequest);\n    context.addPlan(thePlan);\n  } else {\n    activeBindings = _getActiveBindings(metadataReader, avoidConstraints, context, parentRequest, target);\n    childRequest = parentRequest.addChildRequest(target.serviceIdentifier, activeBindings, target);\n  }\n  activeBindings.forEach(function (binding) {\n    var subChildRequest = null;\n    if (target.isArray()) {\n      subChildRequest = childRequest.addChildRequest(binding.serviceIdentifier, binding, target);\n    } else {\n      if (binding.cache) {\n        return;\n      }\n      subChildRequest = childRequest;\n    }\n    if (binding.type === literal_types_1.BindingTypeEnum.Instance && binding.implementationType !== null) {\n      var dependencies = reflection_utils_1.getDependencies(metadataReader, binding.implementationType);\n      if (!context.container.options.skipBaseClassChecks) {\n        var baseClassDependencyCount = reflection_utils_1.getBaseClassDependencyCount(metadataReader, binding.implementationType);\n        if (dependencies.length < baseClassDependencyCount) {\n          var error = ERROR_MSGS.ARGUMENTS_LENGTH_MISMATCH(reflection_utils_1.getFunctionName(binding.implementationType));\n          throw new Error(error);\n        }\n      }\n      dependencies.forEach(function (dependency) {\n        _createSubRequests(metadataReader, false, dependency.serviceIdentifier, context, subChildRequest, dependency);\n      });\n    }\n  });\n}\nfunction getBindings(container, serviceIdentifier) {\n  var bindings = [];\n  var bindingDictionary = getBindingDictionary(container);\n  if (bindingDictionary.hasKey(serviceIdentifier)) {\n    bindings = bindingDictionary.get(serviceIdentifier);\n  } else if (container.parent !== null) {\n    bindings = getBindings(container.parent, serviceIdentifier);\n  }\n  return bindings;\n}\nfunction plan(metadataReader, container, isMultiInject, targetType, serviceIdentifier, key, value, avoidConstraints) {\n  if (avoidConstraints === void 0) {\n    avoidConstraints = false;\n  }\n  var context = new context_1.Context(container);\n  var target = _createTarget(isMultiInject, targetType, serviceIdentifier, \"\", key, value);\n  try {\n    _createSubRequests(metadataReader, avoidConstraints, serviceIdentifier, context, null, target);\n    return context;\n  } catch (error) {\n    if (exceptions_1.isStackOverflowExeption(error)) {\n      if (context.plan) {\n        serialization_1.circularDependencyToException(context.plan.rootRequest);\n      }\n    }\n    throw error;\n  }\n}\nexports.plan = plan;\nfunction createMockRequest(container, serviceIdentifier, key, value) {\n  var target = new target_1.Target(literal_types_1.TargetTypeEnum.Variable, \"\", serviceIdentifier, new metadata_1.Metadata(key, value));\n  var context = new context_1.Context(container);\n  var request = new request_1.Request(serviceIdentifier, context, null, [], target);\n  return request;\n}\nexports.createMockRequest = createMockRequest;","map":{"version":3,"names":["binding_count_1","require","ERROR_MSGS","literal_types_1","METADATA_KEY","exceptions_1","serialization_1","context_1","metadata_1","plan_1","reflection_utils_1","request_1","target_1","getBindingDictionary","cntnr","_bindingDictionary","exports","_createTarget","isMultiInject","targetType","serviceIdentifier","name","key","value","metadataKey","MULTI_INJECT_TAG","INJECT_TAG","injectMetadata","Metadata","target","Target","undefined","tagMetadata","metadata","push","_getActiveBindings","metadataReader","avoidConstraints","context","parentRequest","bindings","getBindings","container","activeBindings","length","BindingCount","NoBindingsAvailable","options","autoBindInjectable","getConstructorMetadata","compilerGeneratedMetadata","bind","toSelf","filter","binding","request","Request","constraint","_validateActiveBindingCount","isOptional","serviceIdentifierString","getServiceIdentifierAsString","msg","NOT_REGISTERED","listMetadataForTarget","listRegisteredBindingsForServiceIdentifier","Error","OnlyOneBindingAvailable","isArray","MultipleBindingsAvailable","AMBIGUOUS_MATCH","_createSubRequests","childRequest","thePlan","Plan","addPlan","addChildRequest","forEach","subChildRequest","cache","type","BindingTypeEnum","Instance","implementationType","dependencies","getDependencies","skipBaseClassChecks","baseClassDependencyCount","getBaseClassDependencyCount","error","ARGUMENTS_LENGTH_MISMATCH","getFunctionName","dependency","bindingDictionary","hasKey","get","parent","plan","Context","isStackOverflowExeption","circularDependencyToException","rootRequest","createMockRequest","TargetTypeEnum","Variable"],"sources":["../../src/planning/planner.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}