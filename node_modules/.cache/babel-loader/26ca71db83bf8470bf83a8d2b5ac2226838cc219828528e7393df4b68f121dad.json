{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { get, isArray, map, maxBy, reduce } from '@antv/util';\nimport { geometry as baseGeometry } from '../../../adaptor/geometries/base';\nimport { flow } from '../../../utils';\nimport { getTooltipMapping } from '../../../utils/tooltip';\nimport { FUNNEL_CONVERSATION, FUNNEL_PERCENT, FUNNEL_TOTAL_PERCENT, PLOYGON_X, PLOYGON_Y } from '../constant';\nimport { conversionTagComponent } from './common';\n/**\n * 动态高度漏斗图\n * @param params\n * 需求: 每个漏斗项的高度根据 yfield 等比生成。漏斗上下宽度比为2，即斜率为 2。\n * 实现方式: 使用 g2 多边形，data -> 点坐标 -> 绘制\n * 以漏斗底部中心点为坐标轴原点，漏斗在 -0.5 <= x <= 0.5, 0 <= y <= 1 的正方形中绘制\n * 先计算第一象限的点, 第二象限的点即为镜像 x 轴取反。\n * 第一象限共需计算 data.length + 1 个点，在 y = 4x - 1 上。首尾分别是[0.5, 1], [0.25, 0]。根据 data 计算出 y 值，从而得到 y 值\n */\n/**\n * 处理数据\n * @param params\n */\nfunction field(params) {\n  var chart = params.chart,\n    options = params.options;\n  var _a = options.data,\n    data = _a === void 0 ? [] : _a,\n    yField = options.yField;\n  // 计算各数据项所占高度\n  var sum = reduce(data, function (total, item) {\n    return total + (item[yField] || 0);\n  }, 0);\n  var max = maxBy(data, yField)[yField];\n  var formatData = map(data, function (row, index) {\n    // 储存四个点 x，y 坐标，方向为顺时针，即 [左上, 右上，右下，左下]\n    var x = [];\n    var y = [];\n    row[FUNNEL_TOTAL_PERCENT] = (row[yField] || 0) / sum;\n    // 获取左上角，右上角坐标\n    if (index) {\n      var preItemX = data[index - 1][PLOYGON_X];\n      var preItemY = data[index - 1][PLOYGON_Y];\n      x[0] = preItemX[3];\n      y[0] = preItemY[3];\n      x[1] = preItemX[2];\n      y[1] = preItemY[2];\n    } else {\n      x[0] = -0.5;\n      y[0] = 1;\n      x[1] = 0.5;\n      y[1] = 1;\n    }\n    // 获取右下角坐标\n    y[2] = y[1] - row[FUNNEL_TOTAL_PERCENT];\n    x[2] = (y[2] + 1) / 4;\n    y[3] = y[2];\n    x[3] = -x[2];\n    // 赋值\n    row[PLOYGON_X] = x;\n    row[PLOYGON_Y] = y;\n    row[FUNNEL_PERCENT] = (row[yField] || 0) / max;\n    row[FUNNEL_CONVERSATION] = [get(data, [index - 1, yField]), row[yField]];\n    return row;\n  });\n  chart.data(formatData);\n  return params;\n}\n/**\n * geometry处理\n * @param params\n */\nfunction geometry(params) {\n  var chart = params.chart,\n    options = params.options;\n  var xField = options.xField,\n    yField = options.yField,\n    color = options.color,\n    tooltip = options.tooltip,\n    label = options.label,\n    funnelStyle = options.funnelStyle,\n    state = options.state;\n  var _a = getTooltipMapping(tooltip, [xField, yField]),\n    fields = _a.fields,\n    formatter = _a.formatter;\n  // 绘制漏斗图\n  baseGeometry({\n    chart: chart,\n    options: {\n      type: 'polygon',\n      xField: PLOYGON_X,\n      yField: PLOYGON_Y,\n      colorField: xField,\n      tooltipFields: isArray(fields) && fields.concat([FUNNEL_PERCENT, FUNNEL_CONVERSATION]),\n      label: label,\n      state: state,\n      mapping: {\n        tooltip: formatter,\n        color: color,\n        style: funnelStyle\n      }\n    }\n  });\n  return params;\n}\n/**\n * 转置处理\n * @param params\n */\nfunction transpose(params) {\n  var chart = params.chart,\n    options = params.options;\n  var isTransposed = options.isTransposed;\n  chart.coordinate({\n    type: 'rect',\n    actions: isTransposed ? [['transpose'], ['reflect', 'x']] : []\n  });\n  return params;\n}\n/**\n * 转化率组件\n * @param params\n */\nfunction conversionTag(params) {\n  var getLineCoordinate = function (datum, datumIndex, data, initLineOption) {\n    return __assign(__assign({}, initLineOption), {\n      start: [datum[PLOYGON_X][1], datum[PLOYGON_Y][1]],\n      end: [datum[PLOYGON_X][1] + 0.05, datum[PLOYGON_Y][1]]\n    });\n  };\n  conversionTagComponent(getLineCoordinate)(params);\n  return params;\n}\n/**\n * 动态高度漏斗\n * @param chart\n * @param options\n */\nexport function dynamicHeightFunnel(params) {\n  return flow(field, geometry, transpose, conversionTag)(params);\n}","map":{"version":3,"names":["get","isArray","map","maxBy","reduce","geometry","baseGeometry","flow","getTooltipMapping","FUNNEL_CONVERSATION","FUNNEL_PERCENT","FUNNEL_TOTAL_PERCENT","PLOYGON_X","PLOYGON_Y","conversionTagComponent","field","params","chart","options","_a","data","yField","sum","total","item","max","formatData","row","index","x","y","preItemX","preItemY","xField","color","tooltip","label","funnelStyle","state","fields","formatter","type","colorField","tooltipFields","concat","mapping","style","transpose","isTransposed","coordinate","actions","conversionTag","getLineCoordinate","datum","datumIndex","initLineOption","__assign","start","end","dynamicHeightFunnel"],"sources":["../../../../src/plots/funnel/geometries/dynamic-height.ts"],"sourcesContent":["import { Types } from '@antv/g2';\nimport { get, isArray, map, maxBy, reduce } from '@antv/util';\nimport { geometry as baseGeometry } from '../../../adaptor/geometries/base';\nimport { Params } from '../../../core/adaptor';\nimport { Data, Datum } from '../../../types/common';\nimport { flow } from '../../../utils';\nimport { getTooltipMapping } from '../../../utils/tooltip';\nimport { FUNNEL_CONVERSATION, FUNNEL_PERCENT, FUNNEL_TOTAL_PERCENT, PLOYGON_X, PLOYGON_Y } from '../constant';\nimport { FunnelOptions } from '../types';\nimport { conversionTagComponent } from './common';\n\n/**\n * 动态高度漏斗图\n * @param params\n * 需求: 每个漏斗项的高度根据 yfield 等比生成。漏斗上下宽度比为2，即斜率为 2。\n * 实现方式: 使用 g2 多边形，data -> 点坐标 -> 绘制\n * 以漏斗底部中心点为坐标轴原点，漏斗在 -0.5 <= x <= 0.5, 0 <= y <= 1 的正方形中绘制\n * 先计算第一象限的点, 第二象限的点即为镜像 x 轴取反。\n * 第一象限共需计算 data.length + 1 个点，在 y = 4x - 1 上。首尾分别是[0.5, 1], [0.25, 0]。根据 data 计算出 y 值，从而得到 y 值\n */\n\n/**\n * 处理数据\n * @param params\n */\nfunction field(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart, options } = params;\n  const { data = [], yField } = options;\n\n  // 计算各数据项所占高度\n  const sum = reduce(\n    data,\n    (total, item) => {\n      return total + (item[yField] || 0);\n    },\n    0\n  );\n\n  const max = maxBy(data, yField)[yField];\n\n  const formatData = map(data, (row, index) => {\n    // 储存四个点 x，y 坐标，方向为顺时针，即 [左上, 右上，右下，左下]\n    const x = [];\n    const y = [];\n\n    row[FUNNEL_TOTAL_PERCENT] = (row[yField] || 0) / sum;\n\n    // 获取左上角，右上角坐标\n    if (index) {\n      const preItemX = data[index - 1][PLOYGON_X];\n      const preItemY = data[index - 1][PLOYGON_Y];\n      x[0] = preItemX[3];\n      y[0] = preItemY[3];\n      x[1] = preItemX[2];\n      y[1] = preItemY[2];\n    } else {\n      x[0] = -0.5;\n      y[0] = 1;\n      x[1] = 0.5;\n      y[1] = 1;\n    }\n\n    // 获取右下角坐标\n    y[2] = y[1] - row[FUNNEL_TOTAL_PERCENT];\n    x[2] = (y[2] + 1) / 4;\n    y[3] = y[2];\n    x[3] = -x[2];\n\n    // 赋值\n    row[PLOYGON_X] = x;\n    row[PLOYGON_Y] = y;\n    row[FUNNEL_PERCENT] = (row[yField] || 0) / max;\n    row[FUNNEL_CONVERSATION] = [get(data, [index - 1, yField]), row[yField]];\n    return row;\n  });\n\n  chart.data(formatData);\n\n  return params;\n}\n\n/**\n * geometry处理\n * @param params\n */\nfunction geometry(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart, options } = params;\n  const { xField, yField, color, tooltip, label, funnelStyle, state } = options;\n\n  const { fields, formatter } = getTooltipMapping(tooltip, [xField, yField]);\n  // 绘制漏斗图\n  baseGeometry({\n    chart,\n    options: {\n      type: 'polygon',\n      xField: PLOYGON_X,\n      yField: PLOYGON_Y,\n      colorField: xField,\n      tooltipFields: isArray(fields) && fields.concat([FUNNEL_PERCENT, FUNNEL_CONVERSATION]),\n      label,\n      state,\n      mapping: {\n        tooltip: formatter,\n        color,\n        style: funnelStyle,\n      },\n    },\n  });\n  return params;\n}\n\n/**\n * 转置处理\n * @param params\n */\nfunction transpose(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart, options } = params;\n  const { isTransposed } = options;\n  chart.coordinate({\n    type: 'rect',\n    actions: isTransposed ? [['transpose'], ['reflect', 'x']] : [],\n  });\n  return params;\n}\n\n/**\n * 转化率组件\n * @param params\n */\nfunction conversionTag(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const getLineCoordinate = (\n    datum: Datum,\n    datumIndex: number,\n    data: Data,\n    initLineOption: Record<string, any>\n  ): Types.LineOption => {\n    return {\n      ...initLineOption,\n      start: [datum[PLOYGON_X][1], datum[PLOYGON_Y][1]],\n      end: [datum[PLOYGON_X][1] + 0.05, datum[PLOYGON_Y][1]],\n    };\n  };\n\n  conversionTagComponent(getLineCoordinate)(params);\n\n  return params;\n}\n\n/**\n * 动态高度漏斗\n * @param chart\n * @param options\n */\nexport function dynamicHeightFunnel(params: Params<FunnelOptions>) {\n  return flow(field, geometry, transpose, conversionTag)(params);\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}