{"ast":null,"code":"\"use strict\";\n\nrequire(\"core-js/modules/es.array.push.js\");\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n    return t;\n  };\n  return __assign.apply(this, arguments);\n};\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar d3Force = __importStar(require(\"d3-force\"));\nvar forceGrid_1 = __importDefault(require(\"./forceGrid\"));\nvar mysqlWorkbench_1 = __importDefault(require(\"./mysqlWorkbench\"));\nvar dagre_1 = require(\"../dagre\");\nfunction layout(data, options) {\n  var nodes = data.nodes,\n    edges = data.edges;\n  var width = options.width;\n  var height = options.height;\n  if (!(nodes === null || nodes === void 0 ? void 0 : nodes.length)) return Promise.resolve();\n  // 筛选非叶子节点，做Dagre布局\n  var noLeafNodes = [];\n  nodes.forEach(function (node) {\n    var relateEdges = edges.filter(function (edge) {\n      return edge.source === node.id || edge.target === node.id;\n    });\n    if (relateEdges.length > 1) {\n      var temp = __assign({}, node);\n      delete temp.size;\n      noLeafNodes.push(temp);\n    }\n  });\n  var noLeafEdge = [];\n  edges.forEach(function (edge) {\n    var sourceNode = noLeafNodes.find(function (node) {\n      return node.id === edge.source;\n    });\n    var targetNode = noLeafNodes.find(function (node) {\n      return node.id === edge.target;\n    });\n    if (sourceNode && targetNode) {\n      noLeafEdge.push(edge);\n    }\n  });\n  var graphLayout = new dagre_1.DagreLayout({\n    type: 'dagre',\n    ranksep: options.nodeMinGap,\n    nodesep: options.nodeMinGap\n  });\n  var nodesTmp = graphLayout.layout({\n    nodes: noLeafNodes,\n    edges: noLeafEdge\n  }).nodes;\n  // 布局后，坐标同步\n  nodes.forEach(function (n) {\n    var found = (nodesTmp || []).find(function (temp) {\n      return temp.id === n.id;\n    });\n    n.x = (found === null || found === void 0 ? void 0 : found.x) || width / 2;\n    n.y = (found === null || found === void 0 ? void 0 : found.y) || height / 2;\n  });\n  var copyNodes = JSON.parse(JSON.stringify(nodes));\n  var copyEdges = JSON.parse(JSON.stringify(edges));\n  var simulation = d3Force.forceSimulation().nodes(copyNodes).force(\"link\", d3Force.forceLink(copyEdges).id(function (d) {\n    return d.id;\n  }).distance(function (d) {\n    var edgeInfo = noLeafEdge.find(function (edge) {\n      return edge.source === d.source && edge.target === d.target;\n    });\n    if (edgeInfo) {\n      return 30;\n    }\n    return 20;\n  })).force(\"charge\", d3Force.forceManyBody()).force(\"center\", d3Force.forceCenter(width / 2, height / 2)).force(\"x\", d3Force.forceX(width / 2)).force(\"y\", d3Force.forceY(height / 2)).alpha(0.3).alphaDecay(0.08).alphaMin(0.001);\n  var layoutPromise = new Promise(function (resolve) {\n    simulation.on('end', function () {\n      // 坐标信息同步到nodes,edges中\n      nodes.forEach(function (node) {\n        var nodeInfo = copyNodes.find(function (item) {\n          return item.id === node.id;\n        });\n        if (nodeInfo) {\n          node.x = nodeInfo.x;\n          node.y = nodeInfo.y;\n        }\n      });\n      var minX = Math.min.apply(Math, nodes.map(function (node) {\n        return node.x;\n      }));\n      var maxX = Math.max.apply(Math, nodes.map(function (node) {\n        return node.x;\n      }));\n      var minY = Math.min.apply(Math, nodes.map(function (node) {\n        return node.y;\n      }));\n      var maxY = Math.max.apply(Math, nodes.map(function (node) {\n        return node.y;\n      }));\n      var scalex = width / (maxX - minX);\n      var scaley = height / (maxY - minY);\n      nodes.forEach(function (node) {\n        if (node.x !== undefined && scalex < 1) {\n          node.x = (node.x - minX) * scalex;\n        }\n        if (node.y !== undefined && scaley < 1) {\n          node.y = (node.y - minY) * scaley;\n        }\n      });\n      // 这一步就执行缩小空间。且不考虑节点size\n      nodes.forEach(function (node) {\n        node.sizeTemp = node.size;\n        node.size = [10, 10];\n      });\n      (0, mysqlWorkbench_1.default)(nodes, edges);\n      nodes.forEach(function (node) {\n        node.size = node.sizeTemp || [];\n        delete node.sizeTemp;\n      });\n      // 进行网格对齐+节点大小扩增\n      (0, forceGrid_1.default)({\n        nodes: nodes,\n        edges: edges\n      }, options);\n      resolve();\n    });\n  });\n  return layoutPromise;\n}\nexports.default = layout;","map":{"version":3,"names":["d3Force","__importStar","require","forceGrid_1","__importDefault","mysqlWorkbench_1","dagre_1","layout","data","options","nodes","edges","width","height","length","Promise","resolve","noLeafNodes","forEach","node","relateEdges","filter","edge","source","id","target","temp","__assign","size","push","noLeafEdge","sourceNode","find","targetNode","graphLayout","DagreLayout","type","ranksep","nodeMinGap","nodesep","nodesTmp","n","found","x","y","copyNodes","JSON","parse","stringify","copyEdges","simulation","forceSimulation","force","forceLink","d","distance","edgeInfo","forceManyBody","forceCenter","forceX","forceY","alpha","alphaDecay","alphaMin","layoutPromise","on","nodeInfo","item","minX","Math","min","apply","map","maxX","max","minY","maxY","scalex","scaley","undefined","sizeTemp","default","exports"],"sources":["../../../src/layout/er/core.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}